<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°ê°ì¡°ê° ë¶„ìˆ˜ë‚˜ë¼</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Jua -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Jua', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e0f2fe 0%, #fef3c7 100%);
            min-height: 100vh;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .menu-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .menu-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        /* Canvas ìŠ¤íƒ€ì¼ */
        #fractionCanvas {
            border-radius: 1rem;
            background-color: white;
        }
        
        /* ì„¸ë¡œ ë¶„ìˆ˜ ìŠ¤íƒ€ì¼ */
        .fraction-vertical {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .fraction-numerator {
            font-weight: bold;
            line-height: 1.2;
            padding-bottom: 2px;
        }
        
        .fraction-line {
            width: 100%;
            border-bottom: 3px solid currentColor;
            margin: 4px 0;
            min-width: 50px;
            align-self: stretch;
        }
        
        /* ê²Œì„ ì¹´ë“œ ë‚´ ë¶„ìˆ˜ ì„  ë‘ê»˜ ì¡°ì • */
        #game1-area .fraction-line {
            border-bottom-width: 4px;
        }
        
        .fraction-denominator {
            font-weight: bold;
            line-height: 1.2;
            padding-top: 2px;
        }
        
        .mixed-fraction-container {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            justify-content: center;
        }
        
        .mixed-fraction-whole {
            font-weight: bold;
            align-self: center;
        }
        
        /* API Key ìƒíƒœ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        #apiKeyStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 999;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        #apiKeyStatus.valid {
            background-color: #10b981;
            color: white;
        }
        
        #apiKeyStatus.invalid {
            background-color: #ef4444;
            color: white;
        }
        
        #apiKeyStatus.checking {
            background-color: #f59e0b;
            color: white;
        }
        
        /* ì¹´ë“œ ë’¤ì§‘ê¸° ê²Œì„ ìŠ¤íƒ€ì¼ */
        .card-container {
            perspective: 1000px;
            aspect-ratio: 1;
            min-height: 120px;
        }
        
        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        
        .card.flipped {
            transform: rotateY(180deg);
        }
        
        .card.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: rotateY(180deg);
        }
        
        .card-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 3rem;
        }
        
        .card-back::before {
            content: '?';
            color: white;
            font-weight: bold;
        }
        
        .card.matched .card-front {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }
        
        @keyframes correct {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes incorrect {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .card.correct-animation {
            animation: correct 0.5s;
        }
        
        .card.incorrect-animation {
            animation: incorrect 0.5s;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }
    </style>
</head>
<body>
    <!-- API Key ìƒíƒœ í‘œì‹œ (ìµœìƒë‹¨) -->
    <div id="apiKeyStatus" class="checking">
        ğŸ” API Key í™•ì¸ ì¤‘...
    </div>
    
    <!-- [A] ë©”ì¸ í™”ë©´ (í™ˆ) -->
    <section id="home" class="section active">
        <div class="container mx-auto px-4 py-8">
            <!-- ë°°ë„ˆ 1: ë©”ì¸ íƒ€ì´í‹€ -->
            <div class="text-center mb-8">
                <h1 class="text-6xl md:text-7xl font-bold text-blue-600 mb-2 drop-shadow-lg" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
                    ì¡°ê°ì¡°ê° ë¶„ìˆ˜ë‚˜ë¼
                </h1>
                <p class="text-xl md:text-2xl text-gray-700 mt-2">
                    ì¬ë¯¸ìˆê²Œ ë°°ìš°ëŠ” ë¶„ìˆ˜ íƒêµ¬
                </p>
            </div>
            
            <!-- ë°°ë„ˆ 2: ì¶”ê°€ ì •ë³´ ë°°ë„ˆ -->
            <div class="bg-gradient-to-r from-blue-100 to-purple-100 rounded-xl p-4 mb-8 max-w-4xl mx-auto shadow-md">
                <div class="text-center">
                    <p class="text-lg md:text-xl text-gray-700 font-semibold">
                        ğŸ“ ë‹¤ì–‘í•œ í™œë™ìœ¼ë¡œ ë¶„ìˆ˜ë¥¼ ì¬ë¯¸ìˆê²Œ ë°°ì›Œë´ìš”!
                    </p>
                </div>
            </div>
            
            <!-- ë°°ë„ˆ 3: ì•ˆë‚´ ë°°ë„ˆ -->
            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-4 mb-8 max-w-4xl mx-auto shadow-md">
                <div class="text-center">
                    <p class="text-base md:text-lg text-gray-700">
                        ğŸ’¡ ê° ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ë‹¤ì–‘í•œ ë¶„ìˆ˜ í™œë™ì„ ì‹œì‘í•´ë³´ì„¸ìš”
                    </p>
                </div>
            </div>
            
            <!-- ë©”ë‰´ ì¹´ë“œ ê·¸ë¦¬ë“œ (2x3) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <!-- ë©”ë‰´ ì¹´ë“œ 1: ëˆˆìœ¼ë¡œ ë³´ëŠ” ë¶„ìˆ˜ ì‹¤í—˜ì‹¤ -->
                <button 
                    onclick="showSection('section1')" 
                    class="menu-card bg-gradient-to-br from-pink-300 to-pink-400 rounded-xl p-8 text-left shadow-lg hover:shadow-xl"
                >
                    <div class="text-5xl mb-4">ğŸ§</div>
                    <h2 class="text-3xl font-bold text-white mb-2">ëˆˆìœ¼ë¡œ ë³´ëŠ” ë¶„ìˆ˜ ì‹¤í—˜ì‹¤</h2>
                    <p class="text-lg text-white/90">ì—¬ëŸ¬ ë¶„ìˆ˜ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ë´ìš”</p>
                </button>
                
                <!-- ë©”ë‰´ ì¹´ë“œ 2: ë„ì „ ë¶„ìˆ˜ í€´ì¦ˆ! -->
                <button 
                    onclick="showSection('section2')" 
                    class="menu-card bg-gradient-to-br from-yellow-300 to-yellow-400 rounded-xl p-8 text-left shadow-lg hover:shadow-xl"
                >
                    <div class="text-5xl mb-4">ğŸ¯</div>
                    <h2 class="text-3xl font-bold text-white mb-2">ë„ì „ ë¶„ìˆ˜ í€´ì¦ˆ!</h2>
                    <p class="text-lg text-white/90">ë¶„ìˆ˜ í€´ì¦ˆì— ë„ì „í•´ë´ìš”!</p>
                </button>
                
                <!-- ë©”ë‰´ ì¹´ë“œ 3: ë¶„ìˆ˜ ì§ê¿ ì°¾ê¸° -->
                <button 
                    onclick="showSection('section3')" 
                    class="menu-card bg-gradient-to-br from-purple-300 to-purple-400 rounded-xl p-8 text-left shadow-lg hover:shadow-xl"
                >
                    <div class="text-5xl mb-4">ğŸ§©</div>
                    <h2 class="text-3xl font-bold text-white mb-2">ë¶„ìˆ˜ ì§ê¿ ì°¾ê¸°</h2>
                    <p class="text-lg text-white/90">ê°™ì€ ë¶„ìˆ˜ë¥¼ ì°¾ì•„ë´ìš”!</p>
                </button>
                
                <!-- ë©”ë‰´ ì¹´ë“œ 4: ë¶„ìˆ˜ ë¬´í•œì˜ ê³„ë‹¨ -->
                <button 
                    onclick="showSection('section4')" 
                    class="menu-card bg-gradient-to-br from-green-300 to-green-400 rounded-xl p-8 text-left shadow-lg hover:shadow-xl"
                >
                    <div class="text-5xl mb-4">ğŸƒ</div>
                    <h2 class="text-3xl font-bold text-white mb-2">ë¶„ìˆ˜ ë¬´í•œì˜ ê³„ë‹¨</h2>
                    <p class="text-lg text-white/90">ë¶„ìˆ˜ ë§ì…ˆì„ í’€ë©° ê³„ë‹¨ì„ ì˜¬ë¼ê°€ìš”!</p>
                </button>
                
                <!-- ë©”ë‰´ ì¹´ë“œ 5: ì§€êµ¬ë¥¼ ì§€ì¼œë¼! ë¶„ìˆ˜ ëŒ€ì „ìŸ -->
                <button 
                    onclick="showSection('section5')" 
                    class="menu-card bg-gradient-to-br from-orange-300 to-orange-400 rounded-xl p-8 text-left shadow-lg hover:shadow-xl"
                >
                    <div class="text-5xl mb-4">âš”ï¸</div>
                    <h2 class="text-3xl font-bold text-white mb-2">ì§€êµ¬ë¥¼ ì§€ì¼œë¼! ë¶„ìˆ˜ ëŒ€ì „ìŸ</h2>
                    <p class="text-lg text-white/90">ì§„ë¶„ìˆ˜ì™€ ê°€ë¶„ìˆ˜ë¥¼ ë§ì¶° ì§€êµ¬ë¥¼ ì§€ì¼œìš”!</p>
                </button>
                
                <!-- ë©”ë‰´ ì¹´ë“œ 6: ì‹¤ì „! ë¬¸ì¥ì œ ë¬¸ì œ í’€ê¸° -->
                <button 
                    onclick="showSection('section6')" 
                    class="menu-card bg-gradient-to-br from-cyan-300 to-cyan-400 rounded-xl p-8 text-left shadow-lg hover:shadow-xl"
                >
                    <div class="text-5xl mb-4">ğŸ“</div>
                    <h2 class="text-3xl font-bold text-white mb-2">ì‹¤ì „! ë¬¸ì¥ì œ ë¬¸ì œ í’€ê¸°</h2>
                    <p class="text-lg text-white/90">ë¬¸ì¥ì œ ë¬¸ì œë¥¼ í’€ê³  AI ì„ ìƒë‹˜ì—ê²Œ ë¬¼ì–´ë´ìš”!</p>
                </button>
            </div>
        </div>
    </section>

    <!-- [B] Section 1: ëˆˆìœ¼ë¡œ ë³´ëŠ” ë¶„ìˆ˜ ì‹¤í—˜ì‹¤ -->
    <section id="section1" class="section">
        <div class="container mx-auto px-4 py-8">
            <!-- í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
            <button 
                onclick="showSection('home')" 
                class="btn-primary mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md"
            >
                ğŸ  í™ˆìœ¼ë¡œ
            </button>
            
            <!-- ì œëª© -->
            <h2 class="text-5xl md:text-6xl font-bold text-center text-blue-600 mb-8">
                ğŸ§ ëˆˆìœ¼ë¡œ ë³´ëŠ” ë¶„ìˆ˜ ì‹¤í—˜ì‹¤
            </h2>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 min-h-[600px]">
                <!-- ì—°ìŠµ ëª¨ë“œ ì»¨í…Œì´ë„ˆ -->
                <div id="practice-container" class="w-full h-full">
                    <div id="simulation-area" class="w-full h-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ì¢Œì¸¡: ì¡°ì‘ íŒ¨ë„ -->
                        <div class="space-y-6">
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-6 shadow-md">
                                <h3 class="text-2xl font-bold text-gray-800 mb-4">ë¶„ì (Numerator)</h3>
                                <div class="flex items-center justify-center gap-4">
                                    <button 
                                        onclick="changeNumerator(-1)" 
                                        class="bg-red-400 hover:bg-red-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        -
                                    </button>
                                    <span id="numerator-display" class="text-4xl font-bold text-gray-800 min-w-[60px] text-center">1</span>
                                    <button 
                                        onclick="changeNumerator(1)" 
                                        class="bg-green-400 hover:bg-green-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        +
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 shadow-md">
                                <h3 class="text-2xl font-bold text-gray-800 mb-4">ë¶„ëª¨ (Denominator)</h3>
                                <div class="flex items-center justify-center gap-4">
                                    <button 
                                        onclick="changeDenominator(-1)" 
                                        class="bg-red-400 hover:bg-red-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        -
                                    </button>
                                    <span id="denominator-display" class="text-4xl font-bold text-gray-800 min-w-[60px] text-center">4</span>
                                    <button 
                                        onclick="changeDenominator(1)" 
                                        class="bg-green-400 hover:bg-green-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        +
                                    </button>
                                </div>
                            </div>
                            
                            <!-- í˜„ì¬ ë¶„ìˆ˜ í‘œì‹œ -->
                            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 shadow-md text-center">
                                <h3 class="text-xl font-bold text-gray-700 mb-3">í˜„ì¬ ë¶„ìˆ˜</h3>
                                <div id="fraction-display" class="text-5xl font-bold text-blue-600 mb-2 flex justify-center items-center">
                                    <!-- ì„¸ë¡œ ë¶„ìˆ˜ í˜•íƒœë¡œ í‘œì‹œë¨ -->
                                </div>
                                <div id="mixed-fraction-display" class="text-2xl text-gray-600 flex justify-center items-center">
                                    <!-- ëŒ€ë¶„ìˆ˜ í‘œì‹œ (ê°€ë¶„ìˆ˜ì¼ ê²½ìš°) -->
                                </div>
                            </div>
                            
                            <!-- AI ìŒ¤ ë²„íŠ¼ -->
                            <button 
                                onclick="askAITutor()" 
                                class="btn-primary w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg text-xl"
                            >
                                ğŸ¤·â€â™‚ï¸ ì˜ ëª¨ë¥´ê² ì–´ìš” (AIì„ ìƒë‹˜)
                            </button>
                        </div>
                        
                        <!-- ìš°ì¸¡: ì‹œê°í™” ì˜ì—­ -->
                        <div class="flex items-center justify-center">
                            <canvas id="fractionCanvas" width="400" height="400" class="max-w-full h-auto"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- í€´ì¦ˆ ëª¨ë“œ ì»¨í…Œì´ë„ˆ -->
                <div id="quiz-container" class="w-full h-full hidden">
                    <!-- ì—°ìŠµ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
                    <div class="mb-6 text-center">
                        <button 
                            onclick="switchToPracticeMode()" 
                            class="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-lg transition-all"
                        >
                            ğŸ”™ ì—°ìŠµí•˜ëŸ¬ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                    
                    <!-- í€´ì¦ˆ ë¬¸ì œ ì˜ì—­ -->
                    <div class="space-y-6">
                        <!-- ë¬¸ì œ í‘œì‹œ -->
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 shadow-md text-center">
                            <h3 class="text-2xl font-bold text-gray-700 mb-4">ë‹¤ìŒ ë¶„ìˆ˜ë¥¼ ë§Œë“œì„¸ìš”:</h3>
                            <div id="quiz-problem-display" class="text-6xl font-bold text-blue-600 mb-2 flex justify-center items-center">
                                <!-- ë¬¸ì œ ë¶„ìˆ˜ í‘œì‹œ -->
                            </div>
                            <div class="text-lg text-gray-600 mt-2">
                                ë¬¸ì œ <span id="quiz-current-number">1</span> / <span id="quiz-total-number">10</span>
                            </div>
                        </div>
                        
                        <!-- íŒíŠ¸ ë²„íŠ¼ -->
                        <div class="text-center">
                            <button 
                                onclick="askQuizHint()" 
                                class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg text-lg"
                            >
                                ğŸ’¡ íŒíŠ¸ê°€ í•„ìš”í•´ìš” (AIìŒ¤)
                            </button>
                        </div>
                        
                        <!-- í€´ì¦ˆ Canvas ì˜ì—­ -->
                        <div class="flex items-center justify-center bg-gray-50 rounded-xl p-6">
                            <canvas id="quizCanvas" width="600" height="400" class="max-w-full h-auto cursor-pointer"></canvas>
                        </div>
                        
                        <!-- ì œì¶œ ë²„íŠ¼ ë° í”¼ë“œë°± -->
                        <div class="text-center space-y-4">
                            <button 
                                onclick="submitQuizAnswer()" 
                                class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg text-xl"
                            >
                                ì œì¶œí•˜ê¸°
                            </button>
                            <div id="quiz-feedback" class="text-2xl font-bold min-h-[40px]"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI íŠœí„° ëª¨ë‹¬ -->
            <div id="aiModal" class="modal">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-3xl font-bold text-purple-600">ğŸ¤– ë¶„ìˆ˜ íƒí—˜ëŒ€ì¥ì˜ ì„¤ëª…</h3>
                        <button 
                            onclick="closeAIModal()" 
                            class="text-gray-500 hover:text-gray-700 text-3xl font-bold"
                        >
                            Ã—
                        </button>
                    </div>
                    <div id="aiResponse" class="text-xl text-gray-700 leading-relaxed">
                        <!-- AI ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="mt-6 text-center">
                        <button 
                            onclick="closeAIModal()" 
                            class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-xl shadow-md"
                        >
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- [B] Section 2: ë„ì „! ë¶„ìˆ˜ í€´ì¦ˆ -->
    <section id="section2" class="section">
        <div class="container mx-auto px-4 py-8">
            <!-- í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
            <button 
                onclick="showSection('home')" 
                class="btn-primary mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md"
            >
                ğŸ  í™ˆìœ¼ë¡œ
            </button>
            
            <!-- ì œëª© -->
            <h2 class="text-5xl md:text-6xl font-bold text-center text-yellow-600 mb-8">
                ğŸ¯ ë„ì „! ë¶„ìˆ˜ í€´ì¦ˆ
            </h2>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 min-h-[600px]">
                <!-- ë¬¸ì œ ì˜ì—­ -->
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 shadow-md text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">ë‹¤ìŒ ë¶„ìˆ˜ë¥¼ ë§Œë“œì„¸ìš”:</h3>
                    <div id="quiz2-problem-display" class="flex items-center justify-center gap-3 mb-4">
                        <!-- ë¬¸ì œ ë¶„ìˆ˜ í‘œì‹œ (ìˆ˜í•™ì±… ìŠ¤íƒ€ì¼) -->
                    </div>
                    <button 
                        onclick="generateNewQuiz2Problem()" 
                        class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-2 px-6 rounded-xl shadow-md text-lg"
                    >
                        ğŸ”„ ìƒˆë¡œìš´ ë¬¸ì œ
                    </button>
                </div>
                
                <!-- í”¼ë“œë°± ì˜ì—­ -->
                <div id="quiz2-feedback" class="text-center mb-6 min-h-[60px]">
                    <!-- ì •ë‹µ/ì˜¤ë‹µ í”¼ë“œë°± í‘œì‹œ -->
                </div>
                
                <!-- ë¶„ìˆ˜ ì¡°ì‘ ì˜ì—­ (ì„¹ì…˜ 1 ì¬ì‚¬ìš©) -->
                <div id="quiz2-simulation-area" class="w-full h-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ì¢Œì¸¡: ì¡°ì‘ íŒ¨ë„ -->
                        <div class="space-y-6">
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-6 shadow-md">
                                <h3 class="text-2xl font-bold text-gray-800 mb-4">ë¶„ì (Numerator)</h3>
                                <div class="flex items-center justify-center gap-4">
                                    <button 
                                        onclick="changeQuiz2Numerator(-1)" 
                                        class="bg-red-400 hover:bg-red-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        -
                                    </button>
                                    <span id="quiz2-numerator-display" class="text-4xl font-bold text-gray-800 min-w-[60px] text-center">1</span>
                                    <button 
                                        onclick="changeQuiz2Numerator(1)" 
                                        class="bg-green-400 hover:bg-green-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        +
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 shadow-md">
                                <h3 class="text-2xl font-bold text-gray-800 mb-4">ë¶„ëª¨ (Denominator)</h3>
                                <div class="flex items-center justify-center gap-4">
                                    <button 
                                        onclick="changeQuiz2Denominator(-1)" 
                                        class="bg-red-400 hover:bg-red-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        -
                                    </button>
                                    <span id="quiz2-denominator-display" class="text-4xl font-bold text-gray-800 min-w-[60px] text-center">4</span>
                                    <button 
                                        onclick="changeQuiz2Denominator(1)" 
                                        class="bg-green-400 hover:bg-green-500 text-white font-bold w-12 h-12 rounded-full shadow-md text-xl transition-all"
                                    >
                                        +
                                    </button>
                                </div>
                            </div>
                            
                            <!-- í˜„ì¬ ë¶„ìˆ˜ í‘œì‹œ -->
                            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 shadow-md text-center">
                                <h3 class="text-xl font-bold text-gray-700 mb-3">ë‚´ê°€ ë§Œë“  ë¶„ìˆ˜</h3>
                                <div id="quiz2-fraction-display" class="text-5xl font-bold text-blue-600 mb-2 flex justify-center items-center">
                                    <!-- ì„¸ë¡œ ë¶„ìˆ˜ í˜•íƒœë¡œ í‘œì‹œë¨ -->
                                </div>
                                <div id="quiz2-mixed-fraction-display" class="text-2xl text-gray-600 flex justify-center items-center">
                                    <!-- ëŒ€ë¶„ìˆ˜ í‘œì‹œ (ê°€ë¶„ìˆ˜ì¼ ê²½ìš°) -->
                                </div>
                            </div>
                            
                            <!-- ì •ë‹µ í™•ì¸ ë²„íŠ¼ -->
                            <button 
                                onclick="checkQuiz2Answer()" 
                                class="btn-primary w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg text-xl"
                            >
                                âœ… ì •ë‹µ í™•ì¸
                            </button>
                        </div>
                        
                        <!-- ìš°ì¸¡: ì‹œê°í™” ì˜ì—­ -->
                        <div class="flex items-center justify-center p-4 overflow-auto min-h-[400px]">
                            <canvas id="quiz2Canvas" width="600" height="600" class="max-w-full h-auto"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- [B] Section 3: ë¶„ìˆ˜ ì§ê¿ ì°¾ê¸° -->
    <section id="section3" class="section">
        <div class="container mx-auto px-4 py-8">
            <!-- í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
            <button 
                onclick="showSection('home')" 
                class="btn-primary mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md"
            >
                ğŸ  í™ˆìœ¼ë¡œ
            </button>
            
            <!-- ì œëª© -->
            <h2 class="text-5xl md:text-6xl font-bold text-center text-purple-600 mb-8">
                ğŸ§© ë¶„ìˆ˜ ì§ê¿ ì°¾ê¸°
            </h2>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 min-h-[500px]">
                <div id="game1-area" class="w-full h-full">
                    <!-- ê²Œì„ ì •ë³´ í‘œì‹œ -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-6">
                            <div class="bg-blue-100 px-4 py-2 rounded-lg">
                                <span class="text-sm text-gray-600">ë‚¨ì€ ì‹œê°„</span>
                                <div id="game1-timer" class="text-2xl font-bold text-blue-600">--</div>
                            </div>
                            <div class="bg-red-100 px-4 py-2 rounded-lg">
                                <span class="text-sm text-gray-600">í‹€ë¦° íšŸìˆ˜</span>
                                <div id="game1-errors" class="text-2xl font-bold text-red-600">0</div>
                            </div>
                        </div>
                        <button 
                            id="game1-start-btn" 
                            onclick="startGame1()"
                            class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-6 rounded-xl shadow-md text-lg"
                        >
                            ê²Œì„ ì‹œì‘
                        </button>
                    </div>
                    
                    <!-- ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    <div id="game1-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <!-- ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                    
                    <!-- ì„±ê³µ ë©”ì‹œì§€ -->
                    <div id="game1-success" class="hidden text-center">
                        <div class="text-5xl mb-4">ğŸ‰</div>
                        <h3 class="text-3xl font-bold text-green-600 mb-4">ì„±ê³µ!</h3>
                        <p id="game1-result" class="text-xl text-gray-700 mb-6"></p>
                        <button 
                            onclick="startGame1()"
                            class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-md text-lg"
                        >
                            ë‹¤ì‹œ í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- [B] Section 4: ë¶„ìˆ˜ ë¬´í•œì˜ ê³„ë‹¨ -->
    <section id="section4" class="section">
        <div class="container mx-auto px-4 py-8">
            <!-- í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
            <button 
                onclick="showSection('home')" 
                class="btn-primary mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md"
            >
                ğŸ  í™ˆìœ¼ë¡œ
            </button>
            
            <!-- ì œëª© -->
            <h2 class="text-5xl md:text-6xl font-bold text-center text-green-600 mb-8">
                ğŸƒ ë¶„ìˆ˜ ë¬´í•œì˜ ê³„ë‹¨
            </h2>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 flex justify-center">
                <div id="game2-container" class="relative" style="max-width: 480px; width: 100%; height: 700px; max-height: 80vh; background-color: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.2); overflow: hidden;">
                    <canvas id="game2-canvas" style="display: block; width: 100%; height: 100%;"></canvas>

                    <div class="ui-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;">
                        <div class="header" style="padding: 20px; text-align: center; font-family: 'Black Han Sans', sans-serif; text-shadow: 2px 2px 0 #fff;">
                            <div id="progress-text" style="font-size: 1.2rem; color: #555;">ëª©í‘œ: 100ê³„ë‹¨</div>
                            <div id="score-board" style="font-size: 3rem; color: #ff6b6b;">0 F</div>
                        </div>
                        
                        <div class="controls" style="padding: 20px; display: flex; justify-content: center; pointer-events: auto; margin-bottom: 30px;">
                            <button id="climb-btn" style="width: 200px; height: 80px; font-size: 2rem; font-family: 'Black Han Sans', sans-serif; background-color: #4CAF50; color: white; border: none; border-radius: 40px; box-shadow: 0 8px 0 #388E3C; cursor: pointer; transition: transform 0.1s;" onmousedown="this.style.transform='translateY(4px)'; this.style.boxShadow='0 4px 0 #388E3C';" onmouseup="this.style.transform=''; this.style.boxShadow='0 8px 0 #388E3C';" ontouchstart="this.style.transform='translateY(4px)'; this.style.boxShadow='0 4px 0 #388E3C';" ontouchend="this.style.transform=''; this.style.boxShadow='0 8px 0 #388E3C';">ì˜¤ë¥´ê¸°!</button>
                        </div>
                        
                        <div id="jump-msg" class="jump-effect" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; color: #ffca28; text-shadow: 2px 2px 0 #000; pointer-events: none; display: none;">SUPER JUMP!</div>
                    </div>

                    <div id="quiz-modal" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; z-index: 100;">
                        <div class="quiz-box" style="background-color: white; padding: 30px; border-radius: 20px; width: 80%; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
                            <h2 style="margin-top:0; color:#4CAF50;">ğŸ§© ë¶„ìˆ˜ í€´ì¦ˆ!</h2>
                            <div class="quiz-question" id="quiz-content" style="font-size: 2.5rem; margin-bottom: 20px; font-weight: bold; color: #333;"></div>
                            <div class="options-grid" id="quiz-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- [B] Section 5: ì§€êµ¬ë¥¼ ì§€ì¼œë¼! ë¶„ìˆ˜ ëŒ€ì „ìŸ -->
    <section id="section5" class="section">
        <div class="container mx-auto px-4 py-8">
            <!-- í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
            <button 
                onclick="showSection('home')" 
                class="btn-primary mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md"
            >
                ğŸ  í™ˆìœ¼ë¡œ
            </button>
            
            <!-- ì œëª© -->
            <h2 class="text-5xl md:text-6xl font-bold text-center text-orange-600 mb-8">
                âš”ï¸ ì§€êµ¬ë¥¼ ì§€ì¼œë¼! ë¶„ìˆ˜ ëŒ€ì „ìŸ
            </h2>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 flex justify-center">
                <div id="game3-container" class="relative" style="max-width: 600px; width: 100%; height: 100vh; max-height: 80vh; background: linear-gradient(to bottom, #020024 0%, #090979 35%, #00d4ff 100%); overflow: hidden; box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);">
                    <canvas id="game3-canvas" style="display: block; width: 100%; height: 100%;"></canvas>

                    <div class="ui-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;">
                        <div class="hud-top" style="padding: 20px; display: flex; justify-content: space-between; align-items: flex-start;">
                            <div class="left-group" style="display: flex; flex-direction: column; gap: 10px; align-items: flex-start;">
                                <div id="target-badge" class="target-badge badge-proper" style="background-color: #fff; color: #333; padding: 10px 20px; border-radius: 5px; font-family: 'Black Han Sans', sans-serif; font-size: 1.8rem; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); border: 3px solid #333; transition: all 0.3s; text-align: center; min-width: 120px;">ì§„ë¶„ìˆ˜</div>
                                <div class="score-box" style="font-size: 1.2rem; color:#aaa;">STAGE <span id="stage-num">1</span></div>
                            </div>

                            <div class="info-group" style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
                                <div class="life-box" id="lives" style="font-size: 2rem; color: #ff4757;">â¤ï¸â¤ï¸â¤ï¸</div>
                                <div class="timer-box" id="timer-box" style="font-family: 'Black Han Sans', sans-serif; font-size: 2.5rem; color: #fff; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 10px; border: 2px solid #fff; margin-top: 10px;">
                                    â³ <span id="timer">60</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="stage-banner" style="position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-family: 'Black Han Sans', sans-serif; font-size: 4rem; color: rgba(255, 255, 255, 0.2); white-space: nowrap; pointer-events: none; text-shadow: 0 0 10px rgba(255,255,255,0.1);">STAGE 1</div>
                        <div class="controls-hint" style="position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 1rem; opacity: 0.7; text-shadow: 1px 1px 0 #000;">PC: ì¢Œìš° í™”ì‚´í‘œ / ìŠ¤í˜ì´ìŠ¤ë°”(ë°œì‚¬)<br>í„°ì¹˜: í™”ë©´ ì¢Œìš° í„°ì¹˜ / ì¤‘ì•™ í„°ì¹˜(ë°œì‚¬)</div>
                    </div>

                    <div id="screen-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: auto;">
                        <div class="overlay-content" id="overlay-text" style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- [B] Section 6: ì‹¤ì „! ë¬¸ì¥ì œ ë¬¸ì œ í’€ê¸° -->
    <section id="section6" class="section">
        <div class="container mx-auto px-4 py-8">
            <!-- í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
            <button 
                onclick="showSection('home')" 
                class="btn-primary mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md"
            >
                ğŸ  í™ˆìœ¼ë¡œ
            </button>
            
            <!-- ì œëª© -->
            <h2 class="text-5xl md:text-6xl font-bold text-center text-cyan-600 mb-8">
                ğŸ“ ì‹¤ì „! ë¬¸ì¥ì œ ë¬¸ì œ í’€ê¸°
            </h2>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 min-h-[600px]">
                <!-- ë¬¸ì œ ìƒì„± ë²„íŠ¼ -->
                <div class="text-center mb-6">
                    <button 
                        onclick="generateWordProblem()" 
                        id="generate-problem-btn"
                        class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-lg transition-all"
                    >
                        ğŸ² ìƒˆë¡œìš´ ë¬¸ì œ ë§Œë“¤ê¸°
                    </button>
                </div>
                
                <!-- ë¬¸ì œ í‘œì‹œ ì˜ì—­ -->
                <div id="word-problem-area" class="mb-8 hidden">
                    <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-6 md:p-8 shadow-md mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">ë¬¸ì œ</h3>
                        <div id="word-problem-display" class="text-xl md:text-2xl text-gray-700 leading-relaxed flex flex-wrap items-center gap-2">
                            <!-- ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
                        </div>
                    </div>
                    
                    <!-- ì •ë‹µ ì…ë ¥ ì˜ì—­ -->
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 shadow-md mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”</h3>
                        <div class="flex items-center gap-4 justify-center">
                            <input 
                                type="number" 
                                id="word-problem-answer" 
                                placeholder="ì •ë‹µ"
                                class="text-3xl font-bold text-center w-32 px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-cyan-500 focus:outline-none"
                                min="0"
                            />
                            <button 
                                onclick="checkWordProblemAnswer()" 
                                class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg text-lg"
                            >
                                âœ… ì •ë‹µ í™•ì¸
                            </button>
                        </div>
                        <div id="word-problem-feedback" class="text-center mt-4 min-h-[40px]">
                            <!-- í”¼ë“œë°± í‘œì‹œ -->
                        </div>
                    </div>
                </div>
                
                <!-- AI ì„ ìƒë‹˜ ì±—ë´‡ ì˜ì—­ -->
                <div id="ai-tutor-area" class="hidden">
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            ğŸ¤– AI ì„ ìƒë‹˜ì—ê²Œ íŒíŠ¸ ì–»ê¸°
                        </h3>
                        
                        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
                        <div id="ai-chat-messages" class="bg-white rounded-lg p-4 mb-4 min-h-[200px] max-h-[400px] overflow-y-auto border-2 border-gray-200">
                            <div class="text-gray-500 text-center py-4">
                                AI ì„ ìƒë‹˜ì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”! ì •ë‹µ ëŒ€ì‹  íŒíŠ¸ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.
                            </div>
                        </div>
                        
                        <!-- ì…ë ¥ ì˜ì—­ -->
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="ai-chat-input" 
                                placeholder="ì˜ˆ: ì´ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í’€ì–´ì•¼ í• ê¹Œìš”?"
                                class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                                onkeypress="if(event.key === 'Enter') sendAIChatMessage()"
                            />
                            <button 
                                onclick="sendAIChatMessage()" 
                                class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg"
                            >
                                ì „ì†¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- JavaScript -->
    <script type="module">
        // ========== ì „ì—­ ë³€ìˆ˜ ==========
        let numerator = 1;  // ë¶„ì
        let denominator = 4;  // ë¶„ëª¨
        let API_KEY_FINAL = null;  // API Key (ë‚˜ì¤‘ì— ì„¤ì •ë¨)
        
        // í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸° (config.jsì—ì„œ import)
        import { API_KEY } from './src/config.js';
        
        // ì¦‰ì‹œ API_KEY ì„¤ì • ì‹œë„
        API_KEY_FINAL = API_KEY;
        
        // ë””ë²„ê¹…: í™˜ê²½ë³€ìˆ˜ í™•ì¸
        console.log('=== index.html ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í™˜ê²½ë³€ìˆ˜ í™•ì¸ ===');
        console.log('import.meta.env:', import.meta.env);
        console.log('import.meta.env.VITE_OPENAI_API_KEY:', import.meta.env.VITE_OPENAI_API_KEY);
        console.log('import.meta.env.MODE:', import.meta.env.MODE);
        console.log('import.meta.env.DEV:', import.meta.env.DEV);
        console.log('config.jsì—ì„œ ê°€ì ¸ì˜¨ API_KEY:', API_KEY);
        console.log('API_KEY íƒ€ì…:', typeof API_KEY);
        console.log('API_KEY ê°’:', API_KEY ? `"${API_KEY.substring(0, 10)}..." (ê¸¸ì´: ${API_KEY.length})` : 'undefined ë˜ëŠ” null');
        console.log('window.VITE_OPENAI_API_KEY:', window.VITE_OPENAI_API_KEY);
        
        // API_KEY ì„¤ì • (ì—¬ëŸ¬ ì†ŒìŠ¤ì—ì„œ ì‹œë„)
        if (!API_KEY_FINAL) {
            API_KEY_FINAL = window.VITE_OPENAI_API_KEY || import.meta.env.VITE_OPENAI_API_KEY;
        }
        console.log('ìµœì¢… API_KEY_FINAL:', API_KEY_FINAL ? `"${API_KEY_FINAL.substring(0, 10)}..." (ê¸¸ì´: ${API_KEY_FINAL.length})` : 'undefined ë˜ëŠ” ë¹ˆ ê°’');
        console.log('==========================================');
        
        // config.jsê°€ ë¡œë“œë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸° í›„ API Key ê²€ì¦
        setTimeout(() => {
            // window ê°ì²´ì— ë‹¤ì‹œ í™•ì¸
            if (!API_KEY_FINAL) {
                API_KEY_FINAL = window.VITE_OPENAI_API_KEY || import.meta.env.VITE_OPENAI_API_KEY;
                console.log('setTimeout í›„ ì¬í™•ì¸ - API_KEY_FINAL:', API_KEY_FINAL ? `"${API_KEY_FINAL.substring(0, 10)}..."` : 'ì—†ìŒ');
            }
            checkAPIKey();
        }, 200);
        
        // ========== API Key ê²€ì¦ í•¨ìˆ˜ ==========
        async function checkAPIKey() {
            const statusDiv = document.getElementById('apiKeyStatus');
            
            // API_KEY_FINAL ì¬í™•ì¸ (ë™ì  ì—…ë°ì´íŠ¸)
            let currentAPIKey = API_KEY_FINAL || window.VITE_OPENAI_API_KEY || import.meta.env.VITE_OPENAI_API_KEY;
            
            console.log('checkAPIKey í˜¸ì¶œë¨ - currentAPIKey:', currentAPIKey ? 'ìˆìŒ (ê¸¸ì´: ' + currentAPIKey.length + ')' : 'ì—†ìŒ');
            
            if (!currentAPIKey || currentAPIKey === 'your_api_key_here' || String(currentAPIKey).trim() === '' || currentAPIKey === 'undefined') {
                statusDiv.className = 'invalid';
                statusDiv.textContent = 'âŒ API Key ë¯¸ì„¤ì •';
                statusDiv.title = '.env íŒŒì¼ì— VITE_OPENAI_API_KEY=sk-your-keyë¥¼ ì„¤ì •í•˜ê³  Vite ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì„¸ìš”.';
                console.error('API Keyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.');
                return false;
            }
            
            // API Key í˜•ì‹ í™•ì¸ (sk-ë¡œ ì‹œì‘í•˜ëŠ”ì§€)
            if (!currentAPIKey.startsWith('sk-')) {
                statusDiv.className = 'invalid';
                statusDiv.textContent = 'âš ï¸ API Key í˜•ì‹ ì˜¤ë¥˜';
                statusDiv.title = 'API KeyëŠ” sk-ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.';
                return false;
            }
            
            // ì‹¤ì œ API í˜¸ì¶œë¡œ ê²€ì¦
            statusDiv.className = 'checking';
            statusDiv.textContent = 'ğŸ” API Key ê²€ì¦ ì¤‘...';
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentAPIKey}`
                    }
                });
                
                if (response.ok) {
                    statusDiv.className = 'valid';
                    statusDiv.textContent = 'âœ… API Key ì •ìƒ';
                    statusDiv.title = 'OpenAI APIê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.';
                    return true;
                } else if (response.status === 401) {
                    statusDiv.className = 'invalid';
                    statusDiv.textContent = 'âŒ API Key ì¸ì¦ ì‹¤íŒ¨';
                    statusDiv.title = 'API Keyê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    return false;
                } else {
                    statusDiv.className = 'invalid';
                    statusDiv.textContent = 'âš ï¸ API ì—°ê²° ì˜¤ë¥˜';
                    statusDiv.title = `API ì—°ê²° ì˜¤ë¥˜: ${response.status}`;
                    return false;
                }
            } catch (error) {
                statusDiv.className = 'invalid';
                statusDiv.textContent = 'âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
                statusDiv.title = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                return false;
            }
        }
        
        // ========== ì„¹ì…˜ ì „í™˜ í•¨ìˆ˜ ==========
        function showSection(sectionId) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const allSections = document.querySelectorAll('.section');
            allSections.forEach(section => {
                section.classList.remove('active');
            });
            
            // ì„ íƒí•œ ì„¹ì…˜ ë³´ì´ê¸°
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                // Section 1ë¡œ ì´ë™ ì‹œ Canvas ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                if (sectionId === 'section1') {
                    setTimeout(() => {
                        drawFraction();
                    }, 100);
                }
                // Section 2ë¡œ ì´ë™ ì‹œ í€´ì¦ˆ ì´ˆê¸°í™”
                if (sectionId === 'section2') {
                    // ìƒˆë¡œìš´ ë¬¸ì œ ìƒì„±
                    setTimeout(() => {
                        if (typeof generateNewQuiz2Problem === 'function') {
                            generateNewQuiz2Problem();
                        }
                    }, 100);
                }
                // Section 3ë¡œ ì´ë™ ì‹œ ê²Œì„ ì´ˆê¸°í™”
                if (sectionId === 'section3') {
                    // ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸° ìƒíƒœë¡œ
                    if (typeof game1State !== 'undefined' && !game1State.gameStarted) {
                        const cardsContainer = document.getElementById('game1-cards');
                        const successDiv = document.getElementById('game1-success');
                        const startBtn = document.getElementById('game1-start-btn');
                        if (cardsContainer) cardsContainer.innerHTML = '';
                        if (successDiv) successDiv.classList.add('hidden');
                        if (startBtn) {
                            startBtn.disabled = false;
                            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }
                // Section 4ë¡œ ì´ë™ ì‹œ ê²Œì„ ì´ˆê¸°í™”
                if (sectionId === 'section4') {
                    setTimeout(() => {
                        startGame2();
                    }, 100);
                }
                // Section 5ë¡œ ì´ë™ ì‹œ ê²Œì„ ì´ˆê¸°í™”
                if (sectionId === 'section5') {
                    setTimeout(() => {
                        if (typeof resizeGame3 === 'function') resizeGame3();
                        if (typeof showGame3Intro === 'function') showGame3Intro();
                    }, 100);
                }
                // Section 6ë¡œ ì´ë™ ì‹œ ë¬¸ì œ ìƒì„±
                if (sectionId === 'section6') {
                    setTimeout(() => {
                        if (typeof generateWordProblem === 'function') {
                            generateWordProblem();
                        }
                    }, 100);
                }
            }
        }
        
        // ========== ë¶„ì ì¡°ì ˆ í•¨ìˆ˜ ==========
        function changeNumerator(delta) {
            numerator += delta;
            if (numerator < 0) numerator = 0;
            updateDisplay();
            drawFraction();
        }
        
        // ========== ë¶„ëª¨ ì¡°ì ˆ í•¨ìˆ˜ ==========
        function changeDenominator(delta) {
            denominator += delta;
            if (denominator < 1) denominator = 1;
            if (denominator > 10) denominator = 10;
            updateDisplay();
            drawFraction();
        }
        
        // ========== ì„¸ë¡œ ë¶„ìˆ˜ ë Œë”ë§ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
        /**
         * ë¶„ìˆ˜ë¥¼ ì„¸ë¡œ í˜•íƒœ(êµê³¼ì„œ ìŠ¤íƒ€ì¼)ë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         * @param {number} num - ë¶„ì
         * @param {number} den - ë¶„ëª¨
         * @param {string} sizeClass - Tailwind CSS í¬ê¸° í´ë˜ìŠ¤ (ì˜ˆ: 'text-5xl', 'text-3xl')
         * @returns {string} HTML ë¬¸ìì—´
         */
        function renderFraction(num, den, sizeClass = 'text-5xl') {
            return `
                <div class="fraction-vertical ${sizeClass}">
                    <span class="fraction-numerator">${num}</span>
                    <div class="fraction-line"></div>
                    <span class="fraction-denominator">${den}</span>
                </div>
            `;
        }
        
        /**
         * ëŒ€ë¶„ìˆ˜ë¥¼ ì„¸ë¡œ í˜•íƒœë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
         * @param {number} whole - ìì—°ìˆ˜ ë¶€ë¶„
         * @param {number} num - ë¶„ì
         * @param {number} den - ë¶„ëª¨
         * @param {string} sizeClass - Tailwind CSS í¬ê¸° í´ë˜ìŠ¤
         * @returns {string} HTML ë¬¸ìì—´
         */
        function renderMixedFraction(whole, num, den, sizeClass = 'text-2xl') {
            return `
                <div class="mixed-fraction-container ${sizeClass}">
                    <span class="mixed-fraction-whole">${whole}</span>
                    ${renderFraction(num, den, sizeClass)}
                </div>
            `;
        }
        
        // ========== í™”ë©´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ==========
        function updateDisplay() {
            document.getElementById('numerator-display').textContent = numerator;
            document.getElementById('denominator-display').textContent = denominator;
            
            // ì„¸ë¡œ ë¶„ìˆ˜ í˜•íƒœë¡œ í‘œì‹œ
            const fractionDisplay = document.getElementById('fraction-display');
            fractionDisplay.innerHTML = renderFraction(numerator, denominator, 'text-5xl');
            
            // ëŒ€ë¶„ìˆ˜ í‘œì‹œ (ê°€ë¶„ìˆ˜ì¼ ê²½ìš°)
            const mixedFractionDisplay = document.getElementById('mixed-fraction-display');
            if (numerator >= denominator && denominator > 0) {
                const whole = Math.floor(numerator / denominator);
                const remainder = numerator % denominator;
                if (remainder === 0) {
                    // ì •ìˆ˜ì¸ ê²½ìš°
                    mixedFractionDisplay.innerHTML = `<span class="text-2xl font-bold text-gray-600">${whole}</span>`;
                } else {
                    // ëŒ€ë¶„ìˆ˜ì¸ ê²½ìš°
                    mixedFractionDisplay.innerHTML = renderMixedFraction(whole, remainder, denominator, 'text-2xl');
                }
            } else {
                mixedFractionDisplay.innerHTML = '';
            }
        }
        
        // ========== Canvasì— ë¶„ìˆ˜ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ==========
        function drawFraction() {
            const canvas = document.getElementById('fractionCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            if (denominator === 0) return;
            
            const centerX = width / 2;
            const centerY = height / 2;
            
            // ê°€ë¶„ìˆ˜ ì²˜ë¦¬: ë¶„ìê°€ ë¶„ëª¨ë³´ë‹¤ í¬ë©´ ì—¬ëŸ¬ ê°œì˜ ì› ê·¸ë¦¬ê¸°
            const fullCircles = Math.floor(numerator / denominator);
            const remainder = numerator % denominator;
            const totalCircles = fullCircles + (remainder > 0 ? 1 : 0);
            
            // ë™ì  ë°˜ì§€ë¦„ ê³„ì‚°
            const defaultRadius = 80;  // ê¸°ë³¸ ë°˜ì§€ë¦„
            const defaultGap = 20;  // ì›ë“¤ ì‚¬ì´ì˜ ê¸°ë³¸ ê°„ê²©
            const padding = 20;  // ì–‘ìª½ ì—¬ë°±
            
            // í•„ìš”í•œ ì´ ë„ˆë¹„ ê³„ì‚°
            // ê° ì›ì˜ ì§€ë¦„: radius * 2
            // ì›ë“¤ ì‚¬ì´ì˜ ê°„ê²©: gap
            // ì´ ë„ˆë¹„ = (ì› ê°œìˆ˜ * ì§€ë¦„) + (ì› ê°œìˆ˜ - 1) * ê°„ê²© + ì–‘ìª½ ì—¬ë°±
            const requiredWidth = totalCircles * (defaultRadius * 2) + (totalCircles - 1) * defaultGap + padding * 2;
            
            // ë°˜ì§€ë¦„ê³¼ ê°„ê²©ì„ ë™ì ìœ¼ë¡œ ì¡°ì •
            let radius = defaultRadius;
            let gap = defaultGap;
            
            if (requiredWidth > width) {
                // ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ë¹„ìœ¨ì— ë§ì¶° ì¤„ì„
                const availableWidth = width - padding * 2;
                const scaleFactor = availableWidth / (requiredWidth - padding * 2);
                radius = defaultRadius * scaleFactor;
                gap = defaultGap * scaleFactor;
            }
            
            // ì›ì˜ ì¤‘ì‹¬ ê°„ê²© ê³„ì‚° (ì§€ë¦„ + ê°„ê²©)
            const circleSpacing = radius * 2 + gap;
            
            // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ì‹œì‘ X ì¢Œí‘œ ê³„ì‚°
            const totalWidth = totalCircles * (radius * 2) + (totalCircles - 1) * gap;
            const startX = centerX - totalWidth / 2 + radius;
            
            for (let circleIndex = 0; circleIndex < totalCircles; circleIndex++) {
                const x = startX + circleIndex * circleSpacing;
                const y = centerY;
                
                // í˜„ì¬ ì›ì— ê·¸ë ¤ì•¼ í•  ì¡°ê° ìˆ˜ ê²°ì •
                let slicesToFill;
                if (circleIndex < fullCircles) {
                    slicesToFill = denominator;  // ì™„ì „íˆ ì±„ì›Œì§„ ì›
                } else {
                    slicesToFill = remainder;  // ë‚˜ë¨¸ì§€ ì¡°ê°
                }
                
                // ì› ê·¸ë¦¬ê¸°
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ë¶€ì±„ê¼´ë¡œ ë“±ë¶„í•˜ì—¬ ê·¸ë¦¬ê¸°
                const anglePerSlice = (2 * Math.PI) / denominator;
                
                for (let i = 0; i < denominator; i++) {
                    const startAngle = i * anglePerSlice - Math.PI / 2;  // ìœ„ìª½ë¶€í„° ì‹œì‘
                    const endAngle = (i + 1) * anglePerSlice - Math.PI / 2;
                    
                    // ì¡°ê° ê·¸ë¦¬ê¸°
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.arc(x, y, radius, startAngle, endAngle);
                    ctx.closePath();
                    
                    // ìƒ‰ì¹  ì—¬ë¶€ ê²°ì •
                    if (i < slicesToFill) {
                        // ìƒ‰ì¹ ëœ ì¡°ê° (ë°ì€ ì£¼í™©ìƒ‰ ë˜ëŠ” íŒŒë€ìƒ‰)
                        ctx.fillStyle = i % 2 === 0 ? '#FFB84D' : '#4A90E2';
                    } else {
                        // ìƒ‰ì¹ ë˜ì§€ ì•Šì€ ì¡°ê° (ì—°í•œ íšŒìƒ‰)
                        ctx.fillStyle = '#F0F0F0';
                    }
                    ctx.fill();
                    
                    // ê²½ê³„ì„  ê·¸ë¦¬ê¸°
                    ctx.strokeStyle = '#333333';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }
        
        // ========== AI íŠœí„° í•¨ìˆ˜ ==========
        async function askAITutor() {
            const modal = document.getElementById('aiModal');
            const responseDiv = document.getElementById('aiResponse');
            
            // ëª¨ë‹¬ ì—´ê¸°
            modal.classList.add('active');
            responseDiv.textContent = 'ğŸ¤” ë¶„ìˆ˜ íƒí—˜ëŒ€ì¥ì´ ìƒê° ì¤‘ì´ì—ìš”...';
            
            // API Key í™•ì¸ (ì—¬ëŸ¬ ì†ŒìŠ¤ì—ì„œ ì‹œë„)
            const currentAPIKey = API_KEY_FINAL || window.VITE_OPENAI_API_KEY || import.meta.env.VITE_OPENAI_API_KEY;
            if (!currentAPIKey || currentAPIKey === 'your_api_key_here' || String(currentAPIKey).trim() === '') {
                responseDiv.innerHTML = `
                    <div class="text-red-500 mb-4">
                        âš ï¸ API Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!<br>
                        <code class="bg-gray-100 px-2 py-1 rounded">.env</code> íŒŒì¼ì— <code class="bg-gray-100 px-2 py-1 rounded">VITE_OPENAI_API_KEY=your_api_key</code>ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
                    </div>
                    <div class="text-gray-600">
                        <strong>ì˜ˆì‹œ ì„¤ëª…:</strong><br>
                        í˜„ì¬ ë¶„ìˆ˜ëŠ” ${numerator}/${denominator}ì´ì—ìš”! ğŸ•<br>
                        ${denominator}ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆˆ í”¼ìì—ì„œ ${numerator}ì¡°ê°ì„ ë¨¹ì—ˆë‹¤ëŠ” ëœ»ì´ì—ìš”!<br>
                        ${numerator >= denominator ? `ì™€! í”¼ì í•œ íŒì„ ë‹¤ ë¨¹ê³  ${numerator - denominator}ì¡°ê°ì„ ë” ë¨¹ì—ˆë„¤ìš”!` : 'ì•„ì§ ì¡°ê¸ˆ ë‚¨ì•˜ì–´ìš”!'}
                    </div>
                `;
                return;
            }
            
            try {
                const systemPrompt = `ë„ˆëŠ” ì´ˆë“±í•™ìƒ ìˆ˜í•™ íŠœí„° 'ë¶„ìˆ˜ íƒí—˜ëŒ€ì¥'ì´ì•¼.
ë§íˆ¬: ì¹œì ˆ, ìœ ì¾Œ, ì´ëª¨ì§€ ì‚¬ìš©.
ì„¤ëª…ë²•: 'í”¼ì'ì— ë¹„ìœ í•´ì„œ ì„¤ëª…. (ë¶„ëª¨=í”¼ì ì¡°ê° ìˆ˜, ë¶„ì=ë¨¹ì€ ìˆ˜).
ê°€ë¶„ìˆ˜ ì„¤ëª…: 5/4ë¼ë©´ 'í”¼ì í•œ íŒ ë‹¤ ë¨¹ê³  í•œ ì¡°ê° ë”!' ì‹ìœ¼ë¡œ ì‹œê°ì  ì„¤ëª….
ê¸¸ì´: 3ë¬¸ì¥ ì´ë‚´.`;
                
                const userPrompt = `í˜„ì¬ ë¶„ëª¨ëŠ” ${denominator}, ë¶„ìëŠ” ${numerator}ì´ì•¼. ê·¸ë¦¼ìœ¼ë¡œ ì›ì´ ê·¸ë ¤ì ¸ ìˆì–´. ì´ê²Œ ë¬´ìŠ¨ ëœ»ì¸ì§€ ì‰½ê²Œ ì„¤ëª…í•´ì¤˜.`;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAPIKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        max_tokens: 200,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                const aiMessage = data.choices[0].message.content;
                responseDiv.textContent = aiMessage;
                
            } catch (error) {
                console.error('AI íŠœí„° ì˜¤ë¥˜:', error);
                responseDiv.innerHTML = `
                    <div class="text-red-500">
                        ğŸ˜¢ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ${error.message}<br>
                        API Keyë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </div>
                `;
            }
        }
        
        // ========== AI ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ ==========
        function closeAIModal() {
            const modal = document.getElementById('aiModal');
            modal.classList.remove('active');
        }
        
        // ========== ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸° (onclick ì†ì„± ì‚¬ìš©ì„ ìœ„í•´) ==========
        window.showSection = showSection;
        window.changeNumerator = changeNumerator;
        window.changeDenominator = changeDenominator;
        window.askAITutor = askAITutor;
        window.closeAIModal = closeAIModal;
        window.renderFraction = renderFraction;
        window.renderMixedFraction = renderMixedFraction;
        
        // ========== Section 1: í€´ì¦ˆ ëª¨ë“œ ==========
        let quizState = {
            problems: [], // 10ë¬¸ì œ ë°°ì—´
            currentProblemIndex: 0,
            selectedPieces: [], // ì„ íƒëœ ì¡°ê°ë“¤ [circleIndex, pieceIndex]
            totalCorrect: 0,
            isQuizActive: false
        };
        
        // í€´ì¦ˆ ë¬¸ì œ ìƒì„± (10ë¬¸ì œ)
        function generateQuizProblems() {
            const problems = [];
            const types = ['proper', 'improper', 'mixed']; // ì§„ë¶„ìˆ˜, ê°€ë¶„ìˆ˜, ëŒ€ë¶„ìˆ˜
            
            for (let i = 0; i < 10; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                let denominator = Math.floor(Math.random() * 9) + 2; // 2~10
                let numerator, whole = 0;
                
                if (type === 'proper') {
                    // ì§„ë¶„ìˆ˜: ë¶„ì < ë¶„ëª¨
                    numerator = Math.floor(Math.random() * (denominator - 1)) + 1;
                } else if (type === 'improper') {
                    // ê°€ë¶„ìˆ˜: ë¶„ì >= ë¶„ëª¨, ìµœëŒ€ ë¶„ì = ë¶„ëª¨ * 2
                    numerator = Math.floor(Math.random() * denominator) + denominator; // ë¶„ëª¨ ~ ë¶„ëª¨*2
                } else {
                    // ëŒ€ë¶„ìˆ˜: ìì—°ìˆ˜ 1~3
                    whole = Math.floor(Math.random() * 3) + 1; // 1~3
                    numerator = Math.floor(Math.random() * denominator) + 1; // 1 ~ ë¶„ëª¨
                }
                
                problems.push({
                    type: type,
                    whole: whole,
                    numerator: numerator,
                    denominator: denominator,
                    // ê°€ë¶„ìˆ˜ë¡œ ë³€í™˜ (ë¹„êµìš©)
                    improperNumerator: whole * denominator + numerator
                });
            }
            
            return problems;
        }
        
        // í€´ì¦ˆ ëª¨ë“œë¡œ ì „í™˜
        function switchToQuizMode() {
            const practiceContainer = document.getElementById('practice-container');
            const quizContainer = document.getElementById('quiz-container');
            
            if (!practiceContainer || !quizContainer) return;
            
            // í€´ì¦ˆ ì´ˆê¸°í™”
            quizState.problems = generateQuizProblems();
            quizState.currentProblemIndex = 0;
            quizState.selectedPieces = [];
            quizState.totalCorrect = 0;
            quizState.isQuizActive = true;
            
            // í™”ë©´ ì „í™˜
            practiceContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            
            // Canvas í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            setTimeout(() => {
                const quizCanvas = document.getElementById('quizCanvas');
                if (quizCanvas) {
                    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡
                    quizCanvas.removeEventListener('click', handleQuizCanvasClick);
                    quizCanvas.addEventListener('click', handleQuizCanvasClick);
                }
            }, 100);
            
            // ì²« ë¬¸ì œ í‘œì‹œ
            loadQuizProblem(0);
        }
        
        // ì—°ìŠµ ëª¨ë“œë¡œ ì „í™˜
        function switchToPracticeMode() {
            const practiceContainer = document.getElementById('practice-container');
            const quizContainer = document.getElementById('quiz-container');
            
            if (!practiceContainer || !quizContainer) return;
            
            quizState.isQuizActive = false;
            
            // í™”ë©´ ì „í™˜
            quizContainer.classList.add('hidden');
            practiceContainer.classList.remove('hidden');
        }
        
        // í€´ì¦ˆ ë¬¸ì œ ë¡œë“œ
        function loadQuizProblem(index) {
            if (index >= quizState.problems.length) {
                showQuizResult();
                return;
            }
            
            const problem = quizState.problems[index];
            quizState.currentProblemIndex = index;
            quizState.selectedPieces = [];
            
            // ë¬¸ì œ í‘œì‹œ
            const problemDisplay = document.getElementById('quiz-problem-display');
            const currentNumber = document.getElementById('quiz-current-number');
            const totalNumber = document.getElementById('quiz-total-number');
            
            if (problemDisplay) {
                if (problem.type === 'mixed') {
                    problemDisplay.innerHTML = renderMixedFraction(problem.whole, problem.numerator, problem.denominator, 'text-6xl');
                } else {
                    problemDisplay.innerHTML = renderFraction(problem.numerator, problem.denominator, 'text-6xl');
                }
            }
            
            if (currentNumber) currentNumber.textContent = index + 1;
            if (totalNumber) totalNumber.textContent = quizState.problems.length;
            
            // í”¼ë“œë°± ì´ˆê¸°í™”
            const feedback = document.getElementById('quiz-feedback');
            if (feedback) feedback.textContent = '';
            
            // Canvas ê·¸ë¦¬ê¸°
            drawQuizCanvas(problem);
        }
        
        // í€´ì¦ˆ Canvas ê·¸ë¦¬ê¸°
        function drawQuizCanvas(problem) {
            const canvas = document.getElementById('quizCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // ë°°ê²½ ì´ˆê¸°í™”
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(0, 0, width, height);
            
            // í•„ìš”í•œ ì›ì˜ ê°œìˆ˜ ê³„ì‚° (ê°€ë¶„ìˆ˜ ê¸°ì¤€)
            const totalPieces = problem.improperNumerator;
            const piecesPerCircle = problem.denominator;
            const totalCircles = Math.ceil(totalPieces / piecesPerCircle);
            
            // ì› í¬ê¸° ë° ê°„ê²© ê³„ì‚°
            const padding = 40;
            const gap = 20;
            const maxRadius = Math.min((width - padding * 2) / (totalCircles * 2 + (totalCircles - 1) * gap / 50), (height - padding * 2) / 2);
            const radius = maxRadius * 0.9;
            
            // ì‹œì‘ X ìœ„ì¹˜ (ì¤‘ì•™ ì •ë ¬)
            const totalWidth = totalCircles * radius * 2 + (totalCircles - 1) * gap;
            let startX = (width - totalWidth) / 2 + radius;
            const centerY = height / 2;
            
            // ì› ê·¸ë¦¬ê¸°
            let pieceIndex = 0;
            for (let circleIdx = 0; circleIdx < totalCircles; circleIdx++) {
                const centerX = startX + circleIdx * (radius * 2 + gap);
                const piecesInThisCircle = Math.min(piecesPerCircle, totalPieces - pieceIndex);
                
                // ì› í…Œë‘ë¦¬
                ctx.strokeStyle = '#4b5563';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.stroke();
                
                // ì¡°ê° ë‚˜ëˆ„ê¸°
                for (let i = 0; i < piecesInThisCircle; i++) {
                    const angle = (Math.PI * 2 * i) / piecesPerCircle;
                    const nextAngle = (Math.PI * 2 * (i + 1)) / piecesPerCircle;
                    
                    // ì¡°ê° ê²½ê³„ì„ 
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.lineTo(
                        centerX + Math.cos(angle) * radius,
                        centerY + Math.sin(angle) * radius
                    );
                    ctx.stroke();
                    
                    // ì„ íƒëœ ì¡°ê° ìƒ‰ì¹ 
                    const isSelected = quizState.selectedPieces.some(
                        sp => sp[0] === circleIdx && sp[1] === i
                    );
                    
                    if (isSelected) {
                        ctx.fillStyle = '#f97316'; // ì˜¤ë Œì§€ìƒ‰
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        ctx.arc(centerX, centerY, radius, angle, nextAngle);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
                
                pieceIndex += piecesInThisCircle;
            }
            
            // í´ë¦­ ì˜ì—­ ì €ì¥ (ë‚˜ì¤‘ì— í´ë¦­ ê°ì§€ìš©)
            canvas._quizData = {
                problem: problem,
                circles: []
            };
            
            pieceIndex = 0;
            for (let circleIdx = 0; circleIdx < totalCircles; circleIdx++) {
                const centerX = startX + circleIdx * (radius * 2 + gap);
                const piecesInThisCircle = Math.min(piecesPerCircle, totalPieces - pieceIndex);
                canvas._quizData.circles.push({
                    centerX: centerX,
                    centerY: centerY,
                    radius: radius,
                    pieces: piecesInThisCircle
                });
                pieceIndex += piecesInThisCircle;
            }
        }
        
        // í€´ì¦ˆ Canvas í´ë¦­ ì´ë²¤íŠ¸
        function handleQuizCanvasClick(event) {
            if (!quizState.isQuizActive) return;
            
            const canvas = document.getElementById('quizCanvas');
            if (!canvas || !canvas._quizData) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const problem = canvas._quizData.problem;
            const piecesPerCircle = problem.denominator;
            
            // í´ë¦­í•œ ì¡°ê° ì°¾ê¸°
            for (let circleIdx = 0; circleIdx < canvas._quizData.circles.length; circleIdx++) {
                const circle = canvas._quizData.circles[circleIdx];
                const dx = x - circle.centerX;
                const dy = y - circle.centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= circle.radius) {
                    // ê°ë„ ê³„ì‚°
                    let angle = Math.atan2(dy, dx);
                    if (angle < 0) angle += Math.PI * 2;
                    
                    // ì¡°ê° ì¸ë±ìŠ¤ ê³„ì‚°
                    const pieceAngle = (Math.PI * 2) / piecesPerCircle;
                    let pieceIdx = Math.floor(angle / pieceAngle);
                    if (pieceIdx >= piecesPerCircle) pieceIdx = piecesPerCircle - 1;
                    
                    // Toggle ì„ íƒ
                    const selectedIndex = quizState.selectedPieces.findIndex(
                        sp => sp[0] === circleIdx && sp[1] === pieceIdx
                    );
                    
                    if (selectedIndex >= 0) {
                        // ì´ë¯¸ ì„ íƒë¨ -> ì·¨ì†Œ
                        quizState.selectedPieces.splice(selectedIndex, 1);
                    } else {
                        // ì„ íƒ
                        quizState.selectedPieces.push([circleIdx, pieceIdx]);
                    }
                    
                    // Canvas ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    drawQuizCanvas(problem);
                    break;
                }
            }
        }
        
        // ì •ë‹µ ì œì¶œ
        function submitQuizAnswer() {
            const problem = quizState.problems[quizState.currentProblemIndex];
            const selectedCount = quizState.selectedPieces.length;
            const correctCount = problem.improperNumerator;
            
            const feedback = document.getElementById('quiz-feedback');
            if (!feedback) return;
            
            if (selectedCount === correctCount) {
                // ì •ë‹µ
                quizState.totalCorrect++;
                feedback.textContent = 'ë”©ë™ëŒ•! ğŸ‰';
                feedback.className = 'text-2xl font-bold min-h-[40px] text-green-600';
                
                // ë‹¤ìŒ ë¬¸ì œë¡œ (1ì´ˆ í›„)
                setTimeout(() => {
                    loadQuizProblem(quizState.currentProblemIndex + 1);
                }, 1500);
            } else {
                // ì˜¤ë‹µ
                feedback.textContent = 'ë‹¤ì‹œ í•´ë³¼ê¹Œìš”?';
                feedback.className = 'text-2xl font-bold min-h-[40px] text-red-600';
            }
        }
        
        // í€´ì¦ˆ íŒíŠ¸ (AI)
        async function askQuizHint() {
            const problem = quizState.problems[quizState.currentProblemIndex];
            const currentAPIKey = API_KEY_FINAL || import.meta.env.VITE_OPENAI_API_KEY;
            
            if (!currentAPIKey) {
                alert('API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const modal = document.getElementById('aiModal');
            const responseDiv = document.getElementById('aiResponse');
            
            if (responseDiv) {
                responseDiv.innerHTML = '<div class="text-center">ğŸ’­ íŒíŠ¸ë¥¼ ìƒê°í•˜ê³  ìˆì–´ìš”...</div>';
            }
            
            modal.classList.add('active');
            
            try {
                const systemPrompt = `ë„ˆëŠ” ì´ˆë“±í•™ìƒ ìˆ˜í•™ íŠœí„° 'ë¶„ìˆ˜ íƒí—˜ëŒ€ì¥'ì´ì•¼.
ë§íˆ¬: ì¹œì ˆ, ìœ ì¾Œ, ì´ëª¨ì§€ ì‚¬ìš©.
ì„¤ëª…ë²•: 'í”¼ì'ì— ë¹„ìœ í•´ì„œ ì„¤ëª…. (ë¶„ëª¨=í”¼ì ì¡°ê° ìˆ˜, ë¶„ì=ë¨¹ì€ ìˆ˜).
íŒíŠ¸: ì •ë‹µì„ ë°”ë¡œ ë§í•˜ì§€ ë§ê³ , ìƒê°í•  ê±°ë¦¬ë¥¼ ì¤˜ì•¼ í•´.
ê¸¸ì´: 1ë¬¸ì¥.`;
                
                let userPrompt = '';
                if (problem.type === 'mixed') {
                    userPrompt = `ë¬¸ì œëŠ” ë¶„ëª¨ ${problem.denominator}, ìì—°ìˆ˜ ë¶€ë¶„ ${problem.whole}, ë¶„ì ${problem.numerator}ì•¼. ì•„ì´ê°€ ìƒ‰ì¹ ì„ ì–´ë ¤ì›Œí•´. í”¼ì ì¡°ê°ì— ë¹„ìœ í•´ì„œ ì •ë‹µì„ ìœ ë„í•˜ëŠ” íŒíŠ¸ë¥¼ 1ë¬¸ì¥ìœ¼ë¡œ ì¤˜.`;
                } else {
                    userPrompt = `ë¬¸ì œëŠ” ë¶„ëª¨ ${problem.denominator}, ë¶„ì ${problem.numerator}ì•¼. ì•„ì´ê°€ ìƒ‰ì¹ ì„ ì–´ë ¤ì›Œí•´. í”¼ì ì¡°ê°ì— ë¹„ìœ í•´ì„œ ì •ë‹µì„ ìœ ë„í•˜ëŠ” íŒíŠ¸ë¥¼ 1ë¬¸ì¥ìœ¼ë¡œ ì¤˜.`;
                }
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAPIKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                const aiMessage = data.choices[0].message.content;
                
                if (responseDiv) {
                    responseDiv.innerHTML = `<div class="text-lg">${aiMessage}</div>`;
                }
                
            } catch (error) {
                console.error('AI íŒíŠ¸ ì˜¤ë¥˜:', error);
                if (responseDiv) {
                    responseDiv.innerHTML = `
                        <div class="text-red-500">
                            ğŸ˜¢ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ${error.message}<br>
                            API Keyë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                        </div>
                    `;
                }
            }
        }
        
        // í€´ì¦ˆ ê²°ê³¼ í‘œì‹œ
        function showQuizResult() {
            const quizContainer = document.getElementById('quiz-container');
            if (!quizContainer) return;
            
            const score = quizState.totalCorrect;
            const total = quizState.problems.length;
            const percentage = Math.round((score / total) * 100);
            
            quizContainer.innerHTML = `
                <div class="text-center space-y-6 py-12">
                    <h2 class="text-5xl font-bold text-blue-600 mb-4">ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!</h2>
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-8 shadow-lg">
                        <div class="text-4xl font-bold text-gray-800 mb-4">
                            ì •ë‹µ: ${score} / ${total}
                        </div>
                        <div class="text-3xl font-bold text-blue-600 mb-6">
                            ${percentage}ì 
                        </div>
                        <div class="text-xl text-gray-600 mb-6">
                            ${percentage >= 80 ? 'ğŸŒŸ í›Œë¥­í•´ìš”! ë¶„ìˆ˜ë¥¼ ì •ë§ ì˜ ì´í•´í–ˆì–´ìš”!' : 
                              percentage >= 60 ? 'ğŸ‘ ì˜í–ˆì–´ìš”! ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•˜ë©´ ì™„ë²½í•´ìš”!' : 
                              'ğŸ’ª ê´œì°®ì•„ìš”! ë‹¤ì‹œ í•œ ë²ˆ ë„ì „í•´ë³¼ê¹Œìš”?'}
                        </div>
                        <button 
                            onclick="switchToPracticeMode()" 
                            class="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-lg transition-all mr-4"
                        >
                            ğŸ”™ ì—°ìŠµí•˜ëŸ¬ ê°€ê¸°
                        </button>
                        <button 
                            onclick="switchToQuizMode()" 
                            class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-lg transition-all"
                        >
                            ğŸ”„ ë‹¤ì‹œ í’€ê¸°
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
        window.switchToQuizMode = switchToQuizMode;
        window.switchToPracticeMode = switchToPracticeMode;
        window.submitQuizAnswer = submitQuizAnswer;
        window.askQuizHint = askQuizHint;
        
        
        // ========== Section 2: ë„ì „! ë¶„ìˆ˜ í€´ì¦ˆ ==========
        let quiz2State = {
            targetFraction: null,  // ë¬¸ì œ ë¶„ìˆ˜ {whole, numerator, denominator, type, value}
            userNumerator: 1,      // ìœ ì € ì…ë ¥ ë¶„ì
            userDenominator: 4,    // ìœ ì € ì…ë ¥ ë¶„ëª¨
            quizStatus: 'playing'   // 'playing', 'correct', 'incorrect'
        };
        
        // ëœë¤ ë¶„ìˆ˜ ë¬¸ì œ ìƒì„± (ìš”êµ¬ì‚¬í•­ ì¤€ìˆ˜)
        function generateQuiz2Problem() {
            const types = ['proper', 'improper', 'mixed'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            // ë¶„ëª¨: 2 ì´ìƒ 10 ì´í•˜
            const denominator = Math.floor(Math.random() * 9) + 2;
            let numerator, whole = 0;
            
            if (type === 'proper') {
                // ì§„ë¶„ìˆ˜: ë¶„ì < ë¶„ëª¨
                numerator = Math.floor(Math.random() * (denominator - 1)) + 1;
            } else if (type === 'improper') {
                // ê°€ë¶„ìˆ˜: ë¶„ì >= ë¶„ëª¨, ì „ì²´ ê°’ì´ ì•½ 5ë¥¼ ë„˜ì§€ ì•Šë„ë¡
                // ë¶„ëª¨ * 5 ì´í•˜ë¡œ ì œí•œ (ìì—°ìˆ˜ ë¶€ë¶„ì´ 4 ì´í•˜)
                const maxNumerator = Math.min(denominator * 4, denominator * 2 + denominator - 1);
                numerator = Math.floor(Math.random() * (maxNumerator - denominator + 1)) + denominator;
            } else {
                // ëŒ€ë¶„ìˆ˜: ìì—°ìˆ˜ 0~4, ì§„ë¶„ìˆ˜ ì¡°í•©
                whole = Math.floor(Math.random() * 5); // 0~4
                numerator = Math.floor(Math.random() * denominator) + 1; // 1 ~ ë¶„ëª¨
            }
            
            // ê°€ë¶„ìˆ˜ë¡œ ë³€í™˜ (ë¹„êµìš©)
            const improperNumerator = whole * denominator + numerator;
            const value = improperNumerator / denominator;
            
            return {
                type: type,
                whole: whole,
                numerator: numerator,
                denominator: denominator,
                improperNumerator: improperNumerator,
                value: value
            };
        }
        
        // ë¬¸ì œë¥¼ ìˆ˜í•™ì±… ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œ
        function renderQuiz2Problem(problem) {
            const container = document.getElementById('quiz2-problem-display');
            if (!container) return;
            
            if (problem.type === 'mixed' && problem.whole > 0) {
                // ëŒ€ë¶„ìˆ˜: ìì—°ìˆ˜ + ë¶„ìˆ˜
                container.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-5xl md:text-6xl font-bold text-blue-600">${problem.whole}</span>
                        <div class="flex flex-col items-center">
                            <span class="text-2xl md:text-3xl font-semibold">${problem.numerator}</span>
                            <div class="border-b-2 border-black w-full my-1"></div>
                            <span class="text-2xl md:text-3xl font-semibold">${problem.denominator}</span>
                        </div>
                    </div>
                `;
            } else {
                // ê°€ë¶„ìˆ˜ ë˜ëŠ” ì§„ë¶„ìˆ˜: ë¶„ìˆ˜ë§Œ
                container.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-2xl md:text-3xl font-semibold">${problem.numerator}</span>
                        <div class="border-b-2 border-black w-full my-1"></div>
                        <span class="text-2xl md:text-3xl font-semibold">${problem.denominator}</span>
                    </div>
                `;
            }
        }
        
        // ìƒˆë¡œìš´ ë¬¸ì œ ìƒì„±
        function generateNewQuiz2Problem() {
            quiz2State.targetFraction = generateQuiz2Problem();
            quiz2State.userNumerator = 1;
            quiz2State.userDenominator = 4;
            quiz2State.quizStatus = 'playing';
            
            // ë¬¸ì œ í‘œì‹œ
            renderQuiz2Problem(quiz2State.targetFraction);
            
            // í”¼ë“œë°± ì´ˆê¸°í™”
            const feedback = document.getElementById('quiz2-feedback');
            if (feedback) {
                feedback.innerHTML = '';
            }
            
            // UI ì—…ë°ì´íŠ¸
            updateQuiz2Display();
            drawQuiz2Fraction();
        }
        
        // ë¶„ì ë³€ê²½
        function changeQuiz2Numerator(delta) {
            quiz2State.userNumerator += delta;
            if (quiz2State.userNumerator < 0) quiz2State.userNumerator = 0;
            if (quiz2State.userNumerator > 50) quiz2State.userNumerator = 50; // ìƒí•œ ì„¤ì •
            
            updateQuiz2Display();
            drawQuiz2Fraction();
        }
        
        // ë¶„ëª¨ ë³€ê²½
        function changeQuiz2Denominator(delta) {
            quiz2State.userDenominator += delta;
            if (quiz2State.userDenominator < 1) quiz2State.userDenominator = 1;
            if (quiz2State.userDenominator > 10) quiz2State.userDenominator = 10;
            
            updateQuiz2Display();
            drawQuiz2Fraction();
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateQuiz2Display() {
            // ë¶„ì/ë¶„ëª¨ í‘œì‹œ
            const numDisplay = document.getElementById('quiz2-numerator-display');
            const denDisplay = document.getElementById('quiz2-denominator-display');
            if (numDisplay) numDisplay.textContent = quiz2State.userNumerator;
            if (denDisplay) denDisplay.textContent = quiz2State.userDenominator;
            
            // ë¶„ìˆ˜ í‘œì‹œ
            const fractionDisplay = document.getElementById('quiz2-fraction-display');
            const mixedDisplay = document.getElementById('quiz2-mixed-fraction-display');
            
            if (fractionDisplay) {
                fractionDisplay.innerHTML = renderFraction(quiz2State.userNumerator, quiz2State.userDenominator, 'text-5xl');
            }
            
            if (mixedDisplay) {
                if (quiz2State.userNumerator >= quiz2State.userDenominator && quiz2State.userDenominator > 0) {
                    const whole = Math.floor(quiz2State.userNumerator / quiz2State.userDenominator);
                    const remainder = quiz2State.userNumerator % quiz2State.userDenominator;
                    if (remainder > 0) {
                        mixedDisplay.innerHTML = renderMixedFraction(whole, remainder, quiz2State.userDenominator, 'text-2xl');
                    } else {
                        mixedDisplay.innerHTML = `<span class="text-2xl">= ${whole}</span>`;
                    }
                } else {
                    mixedDisplay.innerHTML = '';
                }
            }
        }
        
        // Canvasì— ë¶„ìˆ˜ ê·¸ë¦¬ê¸° (ì—¬ëŸ¬ ì¤„ ìë™ ë°°ì¹˜ ì§€ì›)
        function drawQuiz2Fraction() {
            const canvas = document.getElementById('quiz2Canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Canvas í¬ê¸° ì¡°ì • (ë°˜ì‘í˜•)
            const container = canvas.parentElement;
            let width = 600; // ê¸°ë³¸ í¬ê¸°
            let height = 600;
            
            if (container) {
                const containerRect = container.getBoundingClientRect();
                const availableWidth = containerRect.width - 32; // padding ê³ ë ¤
                const availableHeight = containerRect.height - 32;
                
                // ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ê²Œ ì¡°ì •í•˜ë˜, ìµœì†Œ í¬ê¸° ë³´ì¥
                width = Math.max(300, Math.min(availableWidth, 600));
                height = Math.max(300, Math.min(availableHeight, 600));
                
                // Canvas í¬ê¸° ì„¤ì • (ë‚´ìš© ë³´ì¡´)
                if (canvas.width !== width || canvas.height !== height) {
                    canvas.width = width;
                    canvas.height = height;
                }
            }
            
            // ë°°ê²½ ì´ˆê¸°í™”
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            if (quiz2State.userDenominator === 0) return;
            
            // ê°€ë¶„ìˆ˜ ì²˜ë¦¬
            const fullCircles = Math.floor(quiz2State.userNumerator / quiz2State.userDenominator);
            const remainder = quiz2State.userNumerator % quiz2State.userDenominator;
            const totalCircles = fullCircles + (remainder > 0 ? 1 : 0);
            
            if (totalCircles === 0) {
                // ë¶„ìˆ˜ê°€ 0ì¸ ê²½ìš°
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) * 0.35;
                ctx.fillStyle = '#f0f0f0';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 3;
                ctx.stroke();
                return;
            }
            
            // ì› í¬ê¸° ë° ê°„ê²© ê³„ì‚°
            const padding = 20; // ì»¨í…Œì´ë„ˆ ì—¬ë°±
            const gap = 15; // ì› ì‚¬ì´ ê°„ê²©
            const minRadius = 25; // ìµœì†Œ ë°˜ì§€ë¦„
            const maxRadius = Math.min(width, height) * 0.25; // ìµœëŒ€ ë°˜ì§€ë¦„
            
            // ë¨¼ì € í•œ ì¤„ë¡œ ë°°ì¹˜ ê°€ëŠ¥í•œì§€ í™•ì¸
            const availableWidth = width - padding * 2;
            const availableHeight = height - padding * 2;
            
            // í•œ ì¤„ì— í•„ìš”í•œ ìµœì†Œ ë„ˆë¹„ ê³„ì‚°
            const minWidthForOneRow = totalCircles * (minRadius * 2) + (totalCircles - 1) * gap;
            
            if (minWidthForOneRow <= availableWidth) {
                // í•œ ì¤„ë¡œ ë°°ì¹˜ ê°€ëŠ¥
                const maxRadiusForOneRow = (availableWidth - (totalCircles - 1) * gap) / (totalCircles * 2);
                const radius = Math.max(minRadius, Math.min(maxRadiusForOneRow, maxRadius));
                const circleSpacing = radius * 2 + gap;
                const totalWidth = totalCircles * (radius * 2) + (totalCircles - 1) * gap;
                const startX = (width - totalWidth) / 2 + radius;
                const centerY = height / 2;
                
                // ì› ê·¸ë¦¬ê¸° (í•œ ì¤„)
                for (let circleIndex = 0; circleIndex < totalCircles; circleIndex++) {
                    const x = startX + circleIndex * circleSpacing;
                    const y = centerY;
                    
                    let slicesToFill;
                    if (circleIndex < fullCircles) {
                        slicesToFill = quiz2State.userDenominator;
                    } else {
                        slicesToFill = remainder;
                    }
                    
                    drawCircle(ctx, x, y, radius, slicesToFill, quiz2State.userDenominator);
                }
            } else {
                // ì—¬ëŸ¬ ì¤„ë¡œ ë°°ì¹˜ í•„ìš”
                // í•œ ì¤„ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ì›ì˜ ê°œìˆ˜ ê³„ì‚°
                let circlesPerRow = Math.floor(availableWidth / (minRadius * 2 + gap));
                circlesPerRow = Math.max(1, circlesPerRow); // ìµœì†Œ 1ê°œ
                
                // ì¤„ ìˆ˜ ê³„ì‚°
                const rows = Math.ceil(totalCircles / circlesPerRow);
                
                // ì› í¬ê¸° ê³„ì‚° (ë„ˆë¹„ì™€ ë†’ì´ ëª¨ë‘ ê³ ë ¤)
                const maxRadiusByWidth = (availableWidth - (circlesPerRow - 1) * gap) / (circlesPerRow * 2);
                const maxRadiusByHeight = (availableHeight - (rows - 1) * gap) / (rows * 2);
                const radius = Math.max(minRadius, Math.min(maxRadiusByWidth, maxRadiusByHeight, maxRadius));
                
                const circleSpacing = radius * 2 + gap;
                const rowSpacing = radius * 2 + gap;
                
                // ì› ê·¸ë¦¬ê¸° (ì—¬ëŸ¬ ì¤„)
                for (let circleIndex = 0; circleIndex < totalCircles; circleIndex++) {
                    const row = Math.floor(circleIndex / circlesPerRow);
                    const col = circleIndex % circlesPerRow;
                    
                    // í˜„ì¬ ì¤„ì˜ ì‹¤ì œ ì› ê°œìˆ˜
                    const circlesInThisRow = Math.min(circlesPerRow, totalCircles - row * circlesPerRow);
                    const rowWidth = circlesInThisRow * circleSpacing - gap;
                    const startX = (width - rowWidth) / 2 + radius;
                    
                    const x = startX + col * circleSpacing;
                    const y = padding + radius + row * rowSpacing;
                    
                    let slicesToFill;
                    if (circleIndex < fullCircles) {
                        slicesToFill = quiz2State.userDenominator;
                    } else {
                        slicesToFill = remainder;
                    }
                    
                    drawCircle(ctx, x, y, radius, slicesToFill, quiz2State.userDenominator);
                }
            }
        }
        
        // ì› ê·¸ë¦¬ê¸° í—¬í¼ í•¨ìˆ˜
        function drawCircle(ctx, x, y, radius, slicesToFill, denominator) {
            // ì› í…Œë‘ë¦¬
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ë¶€ì±„ê¼´ë¡œ ë“±ë¶„
            const anglePerSlice = (2 * Math.PI) / denominator;
            
            for (let i = 0; i < denominator; i++) {
                const startAngle = i * anglePerSlice - Math.PI / 2;
                const endAngle = (i + 1) * anglePerSlice - Math.PI / 2;
                
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.arc(x, y, radius, startAngle, endAngle);
                ctx.closePath();
                
                if (i < slicesToFill) {
                    // ìƒ‰ì¹ ëœ ì¡°ê°
                    ctx.fillStyle = i % 2 === 0 ? '#FFB84D' : '#4A90E2';
                } else {
                    // ë¹ˆ ì¡°ê°
                    ctx.fillStyle = '#f0f0f0';
                }
                ctx.fill();
                
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }
        }
        
        // ì •ë‹µ í™•ì¸ (ê°’ ë¹„êµ)
        function checkQuiz2Answer() {
            if (!quiz2State.targetFraction) {
                alert('ë¬¸ì œë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (quiz2State.userDenominator === 0) {
                alert('ë¶„ëª¨ëŠ” 0ì´ ë  ìˆ˜ ì—†ì–´ìš”!');
                return;
            }
            
            // ìœ ì € ì…ë ¥ê°’ ê³„ì‚°
            const userValue = quiz2State.userNumerator / quiz2State.userDenominator;
            const targetValue = quiz2State.targetFraction.value;
            
            // ê°’ ë¹„êµ (ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ ê³ ë ¤)
            const tolerance = 0.0001;
            const isCorrect = Math.abs(userValue - targetValue) < tolerance;
            
            // í”¼ë“œë°± í‘œì‹œ
            const feedback = document.getElementById('quiz2-feedback');
            if (feedback) {
                if (isCorrect) {
                    quiz2State.quizStatus = 'correct';
                    feedback.innerHTML = `
                        <div class="text-4xl font-bold text-green-600 animate-bounce">
                            ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!
                        </div>
                    `;
                } else {
                    quiz2State.quizStatus = 'incorrect';
                    feedback.innerHTML = `
                        <div class="text-4xl font-bold text-red-600">
                            ğŸ¤” ë‹¤ì‹œ ìƒê°í•´ë³¼ê¹Œìš”?
                        </div>
                        <div class="text-lg text-gray-600 mt-2">
                            ì •ë‹µ: ${quiz2State.targetFraction.whole > 0 ? 
                                `${quiz2State.targetFraction.whole}ê³¼ ${quiz2State.targetFraction.numerator}/${quiz2State.targetFraction.denominator}` :
                                `${quiz2State.targetFraction.numerator}/${quiz2State.targetFraction.denominator}`}
                        </div>
                    `;
                }
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
        window.generateNewQuiz2Problem = generateNewQuiz2Problem;
        window.changeQuiz2Numerator = changeQuiz2Numerator;
        window.changeQuiz2Denominator = changeQuiz2Denominator;
        window.checkQuiz2Answer = checkQuiz2Answer;
        
        // ì¹´ë“œìš© ì‘ì€ Canvasì— ë¶„ìˆ˜ ê·¸ë¦¬ê¸° (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ - ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        function drawFractionOnCard(canvas, num, den) {
            const ctx = canvas.getContext('2d');
            
            // Canvas í¬ê¸°ë¥¼ ì¹´ë“œ í¬ê¸°ì— ë§ê²Œ ì„¤ì •
            const container = canvas.parentElement;
            if (container) {
                const rect = container.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            }
            
            const width = canvas.width;
            const height = canvas.height;
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            if (den === 0) return;
            
            const centerX = width / 2;
            const centerY = height / 2;
            
            // ê°€ë¶„ìˆ˜ ì²˜ë¦¬: ë¶„ìê°€ ë¶„ëª¨ë³´ë‹¤ í¬ë©´ ì—¬ëŸ¬ ê°œì˜ ì› ê·¸ë¦¬ê¸°
            const fullCircles = Math.floor(num / den);
            const remainder = num % den;
            const totalCircles = fullCircles + (remainder > 0 ? 1 : 0);
            
            // ë°˜ì§€ë¦„ ê·¹ëŒ€í™”: ìº”ë²„ìŠ¤ í¬ê¸°ì˜ 90% ì‚¬ìš©
            const minDimension = Math.min(width, height);
            const defaultGap = Math.max(4, minDimension * 0.05);  // ìµœì†Œ 4px, ìº”ë²„ìŠ¤ í¬ê¸°ì˜ 5%
            
            // ìµœëŒ€ ë°˜ì§€ë¦„ ê³„ì‚°: ì›ë“¤ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ í¬ê¸°
            let maxRadius;
            if (totalCircles === 1) {
                // ì›ì´ 1ê°œë©´ ìº”ë²„ìŠ¤ì˜ 90% í¬ê¸°
                maxRadius = minDimension * 0.45;  // ì§€ë¦„ì´ 90%ê°€ ë˜ë„ë¡
            } else {
                // ì›ì´ 2ê°œ ì´ìƒì´ë©´ ê°„ê²©ì„ ê³ ë ¤í•˜ì—¬ ê³„ì‚°
                const availableWidth = width - (defaultGap * (totalCircles - 1));
                maxRadius = Math.min(
                    (availableWidth / totalCircles) / 2,  // ê°€ë¡œ ê¸°ì¤€
                    minDimension * 0.45  // ì„¸ë¡œ ê¸°ì¤€
                );
            }
            
            // ìµœëŒ€ ë°˜ì§€ë¦„ì˜ 90%ë¡œ ì„¤ì • (í…Œë‘ë¦¬ì— ê±°ì˜ ë‹¿ì„ ì •ë„)
            const radius = maxRadius * 0.9;
            const gap = defaultGap;
            
            // ì›ì˜ ì¤‘ì‹¬ ê°„ê²© ê³„ì‚° (ì§€ë¦„ + ê°„ê²©)
            const circleSpacing = radius * 2 + gap;
            
            // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ì‹œì‘ X ì¢Œí‘œ ê³„ì‚°
            const totalWidth = totalCircles * (radius * 2) + (totalCircles - 1) * gap;
            const startX = centerX - totalWidth / 2 + radius;
            
            for (let circleIndex = 0; circleIndex < totalCircles; circleIndex++) {
                const x = startX + circleIndex * circleSpacing;
                const y = centerY;
                
                let slicesToFill;
                if (circleIndex < fullCircles) {
                    slicesToFill = den;
                } else {
                    slicesToFill = remainder;
                }
                
                // ì› ê·¸ë¦¬ê¸°
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ë¶€ì±„ê¼´ë¡œ ë“±ë¶„
                const anglePerSlice = (2 * Math.PI) / den;
                
                for (let i = 0; i < den; i++) {
                    const startAngle = i * anglePerSlice - Math.PI / 2;
                    const endAngle = (i + 1) * anglePerSlice - Math.PI / 2;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.arc(x, y, radius, startAngle, endAngle);
                    ctx.closePath();
                    
                    if (i < slicesToFill) {
                        ctx.fillStyle = i % 2 === 0 ? '#FFB84D' : '#4A90E2';
                    } else {
                        ctx.fillStyle = '#F0F0F0';
                    }
                    ctx.fill();
                    
                    ctx.strokeStyle = '#333333';
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                }
            }
        }
        
        // ê²Œì„ ë°ì´í„° ìƒì„±
        function generateGame1Data() {
            // ë¶„ëª¨ ë°°ì—´: 2ë¶€í„° 8ê¹Œì§€
            const denominators = [2, 3, 4, 5, 6, 7, 8];
            const pairs = [];
            
            // 6ìŒ ìƒì„±
            for (let i = 0; i < 6; i++) {
                // ë¶„ëª¨: 2~8 ì¤‘ ëœë¤ ì„ íƒ
                const den = denominators[Math.floor(Math.random() * denominators.length)];
                
                // ë¶„ì: 1 ì´ìƒ, ë¶„ëª¨Ã—2 ì´í•˜ (ëŒ€ë¶„ìˆ˜ë¡œ ë°”ê¿¨ì„ ë•Œ ìì—°ìˆ˜ ë¶€ë¶„ì´ 2 ì´í•˜)
                const maxNumerator = den * 2;
                const num = Math.floor(Math.random() * maxNumerator) + 1; // 1ë¶€í„° den*2ê¹Œì§€
                
                pairs.push({
                    id: i,
                    numerator: num,
                    denominator: den,
                    value: num / den  // ë¹„êµìš©
                });
            }
            
            // ì¹´ë“œ ë°°ì—´ ìƒì„± (ê° ìŒë§ˆë‹¤ ìˆ«ì ì¹´ë“œì™€ ê·¸ë¦¼ ì¹´ë“œ)
            const cards = [];
            pairs.forEach((pair, index) => {
                // ìˆ«ì ì¹´ë“œ
                cards.push({
                    id: `card-${index * 2}`,
                    pairId: index,
                    type: 'number',
                    numerator: pair.numerator,
                    denominator: pair.denominator,
                    value: pair.value
                });
                
                // ê·¸ë¦¼ ì¹´ë“œ
                cards.push({
                    id: `card-${index * 2 + 1}`,
                    pairId: index,
                    type: 'image',
                    numerator: pair.numerator,
                    denominator: pair.denominator,
                    value: pair.value
                });
            });
            
            // ì¹´ë“œ ì„ê¸°
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            
            return cards;
        }
        
        // ì¹´ë“œ HTML ìƒì„±
        function createCardHTML(card, index) {
            const cardId = `game1-card-${index}`;
            let frontContent = '';
            
            if (card.type === 'number') {
                // ìˆ«ì ì¹´ë“œ - ì„¸ë¡œ ë¶„ìˆ˜ (í¬ê²Œ, íŒ¨ë”© ìµœì†Œí™”)
                frontContent = renderFraction(card.numerator, card.denominator, 'text-3xl md:text-5xl');
            } else {
                // ê·¸ë¦¼ ì¹´ë“œ - Canvas (ì¹´ë“œ í¬ê¸°ì— ë§ê²Œ)
                frontContent = `<canvas class="fraction-canvas w-full h-full" data-num="${card.numerator}" data-den="${card.denominator}"></canvas>`;
            }
            
            return `
                <div class="card-container">
                    <div class="card" id="${cardId}" data-index="${index}" data-pair-id="${card.pairId}" onclick="flipCard(${index})">
                        <div class="card-front p-1 md:p-2">
                            ${frontContent}
                        </div>
                        <div class="card-back"></div>
                    </div>
                </div>
            `;
        }
        
        // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
        let game1State = {
            cards: [],
            flippedCards: [],
            matchedPairs: 0,
            errors: 0,
            isFlipping: false,
            gameStarted: false,
            timeLeft: 120,
            timer: null
        };
        
        // ê²Œì„ ì‹œì‘
        function startGame1() {
            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            game1State.cards = generateGame1Data();
            game1State.flippedCards = [];
            game1State.matchedPairs = 0;
            game1State.errors = 0;
            game1State.isFlipping = false;
            game1State.gameStarted = true;
            game1State.timeLeft = 120; // 2ë¶„
            
            // UI ì´ˆê¸°í™”
            const cardsContainer = document.getElementById('game1-cards');
            const successDiv = document.getElementById('game1-success');
            const startBtn = document.getElementById('game1-start-btn');
            
            cardsContainer.innerHTML = '';
            successDiv.classList.add('hidden');
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            // ì¹´ë“œ ìƒì„±
            game1State.cards.forEach((card, index) => {
                cardsContainer.innerHTML += createCardHTML(card, index);
            });
            
            // Canvasì— ê·¸ë¦¼ ê·¸ë¦¬ê¸° (ì¹´ë“œ í¬ê¸°ê°€ ê²°ì •ëœ í›„)
            setTimeout(() => {
                document.querySelectorAll('.fraction-canvas').forEach(canvas => {
                    const num = parseInt(canvas.dataset.num);
                    const den = parseInt(canvas.dataset.den);
                    drawFractionOnCard(canvas, num, den);
                });
            }, 200);
            
            // 2ì´ˆê°„ ì•ë©´ ë³´ì—¬ì£¼ê¸°
            setTimeout(() => {
                document.querySelectorAll('#game1-cards .card').forEach(cardEl => {
                    cardEl.classList.add('flipped');
                });
                
                setTimeout(() => {
                    document.querySelectorAll('#game1-cards .card').forEach(cardEl => {
                        cardEl.classList.remove('flipped');
                    });
                    
                    // íƒ€ì´ë¨¸ ì‹œì‘
                    startGame1Timer();
                }, 2000);
            }, 100);
            
            // ì—ëŸ¬ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            document.getElementById('game1-errors').textContent = '0';
        }
        
        // íƒ€ì´ë¨¸ ì‹œì‘
        function startGame1Timer() {
            if (game1State.timer) {
                clearInterval(game1State.timer);
            }
            
            const timerEl = document.getElementById('game1-timer');
            timerEl.textContent = formatTime(game1State.timeLeft);
            
            game1State.timer = setInterval(() => {
                game1State.timeLeft--;
                timerEl.textContent = formatTime(game1State.timeLeft);
                
                if (game1State.timeLeft <= 0) {
                    clearInterval(game1State.timer);
                    endGame1(false);
                }
            }, 1000);
        }
        
        // ì‹œê°„ í¬ë§·íŒ…
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // ì¹´ë“œ ë’¤ì§‘ê¸°
        function flipCard(index) {
            if (!game1State.gameStarted || game1State.isFlipping) return;
            
            const card = game1State.cards[index];
            const cardEl = document.getElementById(`game1-card-${index}`);
            
            // ì´ë¯¸ ë’¤ì§‘í˜”ê±°ë‚˜ ë§¤ì¹­ëœ ì¹´ë“œëŠ” ë¬´ì‹œ
            if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) {
                return;
            }
            
            // ì¹´ë“œ ë’¤ì§‘ê¸°
            cardEl.classList.add('flipped');
            game1State.flippedCards.push({ index, card });
            
            // ë‘ ì¥ì´ ë’¤ì§‘í˜”ìœ¼ë©´ ë¹„êµ
            if (game1State.flippedCards.length === 2) {
                game1State.isFlipping = true;
                
                setTimeout(() => {
                    checkMatch();
                }, 500);
            }
        }
        
        // ì¹´ë“œ ë§¤ì¹­ í™•ì¸
        function checkMatch() {
            const [first, second] = game1State.flippedCards;
            const firstCard = game1State.cards[first.index];
            const secondCard = game1State.cards[second.index];
            
            const firstEl = document.getElementById(`game1-card-${first.index}`);
            const secondEl = document.getElementById(`game1-card-${second.index}`);
            
            // ê°™ì€ ìŒì¸ì§€ í™•ì¸ (pairIdê°€ ê°™ê³ , íƒ€ì…ì´ ë‹¤ë¦„)
            if (firstCard.pairId === secondCard.pairId && firstCard.type !== secondCard.type) {
                // ì •ë‹µ!
                firstEl.classList.add('matched', 'correct-animation');
                secondEl.classList.add('matched', 'correct-animation');
                
                // ì •ë‹µ íš¨ê³¼
                showFeedback('ë”©ë™ëŒ•! ğŸ‰', 'green');
                
                game1State.matchedPairs++;
                
                // ëª¨ë“  ìŒì„ ë§ì·„ëŠ”ì§€ í™•ì¸
                if (game1State.matchedPairs === 6) {
                    setTimeout(() => {
                        endGame1(true);
                    }, 1000);
                }
            } else {
                // ì˜¤ë‹µ!
                game1State.errors++;
                document.getElementById('game1-errors').textContent = game1State.errors;
                
                firstEl.classList.add('incorrect-animation');
                secondEl.classList.add('incorrect-animation');
                
                showFeedback('ë•¡! ğŸ˜¢', 'red');
                
                // 1ì´ˆ í›„ ë‹¤ì‹œ ë’¤ì§‘ê¸°
                setTimeout(() => {
                    firstEl.classList.remove('flipped', 'incorrect-animation');
                    secondEl.classList.remove('flipped', 'incorrect-animation');
                }, 1000);
            }
            
            // ì´ˆê¸°í™”
            game1State.flippedCards = [];
            
            setTimeout(() => {
                game1State.isFlipping = false;
            }, 1200);
        }
        
        // í”¼ë“œë°± í‘œì‹œ
        function showFeedback(message, color) {
            const feedback = document.createElement('div');
            feedback.textContent = message;
            feedback.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold z-50 pointer-events-none';
            feedback.style.color = color === 'green' ? '#10b981' : '#ef4444';
            feedback.style.animation = 'fadeInOut 1s';
            feedback.style.textShadow = '0 2px 4px rgba(0,0,0,0.3)';
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 1000);
        }
        
        // ê²Œì„ ì¢…ë£Œ
        function endGame1(success) {
            if (game1State.timer) {
                clearInterval(game1State.timer);
            }
            
            game1State.gameStarted = false;
            const startBtn = document.getElementById('game1-start-btn');
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            if (success) {
                const successDiv = document.getElementById('game1-success');
                const resultEl = document.getElementById('game1-result');
                const timeUsed = 120 - game1State.timeLeft;
                resultEl.textContent = `í‹€ë¦° íšŸìˆ˜: ${game1State.errors}íšŒ, ì†Œìš” ì‹œê°„: ${formatTime(timeUsed)}`;
                successDiv.classList.remove('hidden');
            } else {
                alert('ì‹œê°„ì´ ë‹¤ ë˜ì—ˆì–´ìš”! ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
        window.startGame1 = startGame1;
        window.flipCard = flipCard;
        
        // ========== Section 3: ë¶„ìˆ˜ ë¬´í•œì˜ ê³„ë‹¨ ==========
        let game2State = {
            canvas: null,
            ctx: null,
            currentStep: 0,
            TARGET_STEP: 100,
            isQuizActive: false,
            cameraY: 0,
            charJumpOffset: 0,
            isJumping: false,
            animationId: null
        };
        
        // ê²Œì„ ì´ˆê¸°í™”
        function initGame2() {
            const canvas = document.getElementById('game2-canvas');
            if (!canvas) return;
            
            function resize() {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            window.addEventListener('resize', resize);
            resize();
            
            game2State.canvas = canvas;
            game2State.ctx = canvas.getContext('2d');
        }
        
        // ê²Œì„ ì‹œì‘
        function startGame2() {
            initGame2();
            
            game2State.currentStep = 0;
            game2State.isQuizActive = false;
            game2State.cameraY = 0;
            game2State.charJumpOffset = 0;
            game2State.isJumping = false;
            
            const scoreBoard = document.getElementById('score-board');
            if (scoreBoard) scoreBoard.innerText = '0 F';
            
            const quizModal = document.getElementById('quiz-modal');
            if (quizModal) quizModal.style.display = 'none';
            
            draw();
        }
        
        // ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function draw() {
            const ctx = game2State.ctx;
            const canvas = game2State.canvas;
            if (!ctx || !canvas) return;
            
            ctx.fillStyle = "#E0F7FA";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 + 100;

            // ê³„ë‹¨ ê·¸ë¦¬ê¸°
            ctx.fillStyle = "#8D6E63";
            ctx.strokeStyle = "#5D4037";
            const visibleSteps = 15;
            const stepWidth = 60;
            const stepHeight = 40;

            for (let i = game2State.currentStep - 5; i < game2State.currentStep + visibleSteps; i++) {
                if (i < 0) continue;

                const stepRelIndex = i - game2State.currentStep; 
                const x = centerX + (stepRelIndex * stepWidth);
                const y = centerY - (stepRelIndex * stepHeight) + game2State.cameraY;

                ctx.beginPath();
                ctx.rect(x - stepWidth/2, y, stepWidth, stepHeight);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = "#6D4C41";
                ctx.beginPath();
                ctx.rect(x - stepWidth/2, y + stepHeight, stepWidth, stepHeight);
                ctx.fill();
                ctx.stroke();
                
                ctx.fillStyle = "#8D6E63";

                if (i === 100) {
                    ctx.fillStyle = "red";
                    ctx.font = "30px Arial";
                    ctx.fillText("ğŸš©", x - 15, y - 10);
                }
            }

            // ìºë¦­í„° ê·¸ë¦¬ê¸°
            const charScreenX = centerX;
            const charScreenY = centerY + game2State.cameraY - game2State.charJumpOffset; 
            
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.beginPath();
            ctx.ellipse(charScreenX, centerY + stepHeight/2, 20, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = "#FF7043";
            ctx.beginPath();
            ctx.arc(charScreenX, charScreenY - 20, 25, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(charScreenX - 8, charScreenY - 25, 8, 0, Math.PI * 2);
            ctx.arc(charScreenX + 8, charScreenY - 25, 8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(charScreenX - 8, charScreenY - 25, 3, 0, Math.PI * 2);
            ctx.arc(charScreenX + 8, charScreenY - 25, 3, 0, Math.PI * 2);
            ctx.fill();

            game2State.animationId = requestAnimationFrame(draw);
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë° ê²Œì„ ë¡œì§
        function animateStep() {
            if (game2State.isJumping) return;
            game2State.isJumping = true;
            
            let progress = 0;
            const duration = 150;
            const startTime = performance.now();

            function loop(time) {
                const elapsed = time - startTime;
                progress = Math.min(elapsed / duration, 1);
                game2State.charJumpOffset = Math.sin(progress * Math.PI) * 40;
                
                if (progress < 1) {
                    requestAnimationFrame(loop);
                } else {
                    game2State.isJumping = false;
                    game2State.charJumpOffset = 0;
                }
            }
            requestAnimationFrame(loop);
        }

        function climb() {
            if (game2State.isQuizActive || game2State.currentStep >= game2State.TARGET_STEP) return;

            game2State.currentStep++;
            const scoreBoard = document.getElementById('score-board');
            if (scoreBoard) scoreBoard.innerText = `${game2State.currentStep} F`;
            animateStep();

            if (game2State.currentStep >= game2State.TARGET_STEP) {
                setTimeout(() => alert("ğŸ‰ 100ê³„ë‹¨ ì •ë³µ ì„±ê³µ! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰"), 100);
                return;
            }

            if (game2State.currentStep % 5 === 0) {
                setTimeout(showQuiz, 300);
            }
        }

        function superJump(bonusSteps) {
            const jumpMsg = document.getElementById('jump-msg');
            if (jumpMsg) {
                jumpMsg.style.display = 'block';
                jumpMsg.innerText = `+${bonusSteps} JUMP!`;
                
                setTimeout(() => { jumpMsg.style.display = 'none'; }, 1000);
            }

            let count = 0;
            const interval = setInterval(() => {
                game2State.currentStep++;
                const scoreBoard = document.getElementById('score-board');
                if (scoreBoard) scoreBoard.innerText = `${game2State.currentStep} F`;
                animateStep();
                count++;
                
                if (game2State.currentStep >= game2State.TARGET_STEP) {
                    clearInterval(interval);
                    setTimeout(() => alert("ğŸ‰ 100ê³„ë‹¨ ì •ë³µ ì„±ê³µ! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰"), 500);
                }
                
                if (count >= bonusSteps) clearInterval(interval);
            }, 200);
        }

        // ë¬¸ì œ ìƒì„±ê¸° (ë¶„ìˆ˜ ë§ì…ˆ)
        function generateProblem() {
            const denom = Math.floor(Math.random() * 8) + 2; 
            const num1 = Math.floor(Math.random() * (denom - 1)) + 1;
            const num2 = Math.floor(Math.random() * (denom - 1)) + 1;
            
            let ansNum = num1 + num2;
            let ansDenom = denom;
            
            const integer = Math.floor(ansNum / ansDenom);
            const properNum = ansNum % ansDenom;

            return {
                q: { n1: num1, n2: num2, d: denom },
                a: { int: integer, n: properNum, d: ansDenom } 
            };
        }

        function fractionToHtml(n, d, int=0) {
            let html = '<div class="fraction" style="display: inline-block; vertical-align: middle; text-align: center; font-size: 2rem;">';
            if (int > 0) html += `<span style="font-size:2rem; margin-right:5px;">${int}</span>`;
            if (n > 0 || int === 0 && n === 0) {
                 if (n === 0 && int > 0) {
                     // ì •ìˆ˜ë§Œ ìˆëŠ” ê²½ìš°
                 } else {
                     if (n === 0) { /* 0ì¸ ê²½ìš° */ }
                     else {
                        html += `<div style="display:inline-block; vertical-align:middle;">
                                    <span style="border-bottom: 3px solid #333; display: block; padding: 0 5px;">${n}</span>
                                    <span style="display: block; padding: 0 5px;">${d}</span>
                                </div>`;
                     }
                 }
            }
            if (int === 0 && n === 0) html += "0";
            
            html += '</div>';
            return html;
        }

        function showQuiz() {
            game2State.isQuizActive = true;
            const quizModal = document.getElementById('quiz-modal');
            const quizContent = document.getElementById('quiz-content');
            const quizOptions = document.getElementById('quiz-options');
            
            if (!quizModal || !quizContent || !quizOptions) return;
            
            quizModal.style.display = 'flex';
            
            const problem = generateProblem();
            
            const qHtml = `${fractionToHtml(problem.q.n1, problem.q.d)} + ${fractionToHtml(problem.q.n2, problem.q.d)} = ?`;
            quizContent.innerHTML = qHtml;

            let options = [];
            
            options.push({ 
                html: fractionToHtml(problem.a.n, problem.a.d, problem.a.int), 
                isCorrect: true 
            });

            while (options.length < 4) {
                let wrongNum = problem.q.n1 + problem.q.n2 + Math.floor(Math.random() * 5) - 2;
                if (wrongNum === problem.q.n1 + problem.q.n2) wrongNum += 1;
                if (wrongNum <= 0) wrongNum = 1;

                const wInt = Math.floor(wrongNum / problem.q.d);
                const wN = wrongNum % problem.q.d;
                
                const wHtml = fractionToHtml(wN, problem.q.d, wInt);
                if (!options.some(o => o.html === wHtml)) {
                    options.push({ html: wHtml, isCorrect: false });
                }
            }

            options.sort(() => Math.random() - 0.5);

            quizOptions.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.style.cssText = 'padding: 15px; font-size: 1.5rem; background-color: #FFeb3b; border: 3px solid #FBC02D; border-radius: 10px; cursor: pointer; font-family: Jua, sans-serif;';
                btn.innerHTML = opt.html;
                btn.onclick = () => checkAnswer(opt.isCorrect);
                quizOptions.appendChild(btn);
            });
        }

        function checkAnswer(isCorrect) {
            if (isCorrect) {
                const quizModal = document.getElementById('quiz-modal');
                if (quizModal) quizModal.style.display = 'none';
                game2State.isQuizActive = false;
                const bonus = Math.floor(Math.random() * 9) + 2; 
                superJump(bonus);
            } else {
                alert("í‹€ë ¸ìŠµë‹ˆë‹¤! ë‹¤ì‹œ í’€ì–´ë³´ì„¸ìš”.");
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const climbBtn = document.getElementById('climb-btn');
        if (climbBtn) {
            climbBtn.addEventListener('click', climb);
        }
        
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !game2State.isQuizActive) climb();
        });
        
        // ========== Section 5: ì§€êµ¬ë¥¼ ì§€ì¼œë¼! ë¶„ìˆ˜ ëŒ€ì „ìŸ ==========
        const game3Canvas = document.getElementById('game3-canvas');
        const game3Ctx = game3Canvas?.getContext('2d');
        const game3LivesEl = document.getElementById('lives');
        const game3TimerEl = document.getElementById('timer');
        const game3TimerBox = document.getElementById('timer-box');
        const game3StageNumEl = document.getElementById('stage-num');
        const game3Overlay = document.getElementById('screen-overlay');
        const game3OverlayContent = document.getElementById('overlay-text');
        const game3TargetBadge = document.getElementById('target-badge');
        const game3StageBanner = document.getElementById('stage-banner');

        let game3State = {
            gameRunning: false,
            lives: 3,
            frameCount: 0,
            timeLeft: 60,
            timerInterval: null,
            currentLevel: 1,
            currentTarget: 'proper',
            stage3SwitchTimer: 0,
            player: null,
            bullets: [],
            enemies: [],
            particles: []
        };

        function resizeGame3() {
            if (!game3Canvas) return;
            game3Canvas.width = game3Canvas.parentElement.clientWidth;
            game3Canvas.height = game3Canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resizeGame3);

        // í”Œë ˆì´ì–´
        function createPlayer() {
            return {
                x: game3Canvas.width / 2,
                y: game3Canvas.height - 80,
                width: 50,
                height: 50,
                speed: 7,
                dx: 0,
                draw() {
                    game3Ctx.save();
                    game3Ctx.translate(this.x, this.y);
                    game3Ctx.fillStyle = "#dfe6e9";
                    game3Ctx.beginPath();
                    game3Ctx.moveTo(0, -this.height/2);
                    game3Ctx.lineTo(-this.width/2, this.height/2);
                    game3Ctx.lineTo(this.width/2, this.height/2);
                    game3Ctx.closePath();
                    game3Ctx.fill();
                    game3Ctx.fillStyle = "#74b9ff";
                    game3Ctx.beginPath();
                    game3Ctx.arc(0, 0, 10, 0, Math.PI*2);
                    game3Ctx.fill();
                    game3Ctx.fillStyle = "#ff7675";
                    game3Ctx.beginPath();
                    game3Ctx.moveTo(-10, this.height/2);
                    game3Ctx.lineTo(0, this.height/2 + (Math.random()*15 + 5)); 
                    game3Ctx.lineTo(10, this.height/2);
                    game3Ctx.fill();
                    game3Ctx.restore();
                },
                update() {
                    this.x += this.dx;
                    if (this.x < this.width/2) this.x = this.width/2;
                    if (this.x > game3Canvas.width - this.width/2) this.x = game3Canvas.width - this.width/2;
                }
            };
        }

        // ì´ì•Œ
        class Bullet {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.speed = 10;
                this.radius = 5;
            }
            draw() {
                game3Ctx.fillStyle = "#ffeaa7";
                game3Ctx.beginPath();
                game3Ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                game3Ctx.fill();
            }
            update() {
                this.y -= this.speed;
            }
        }

        // ì  (ë¶„ìˆ˜ ìš´ì„)
        class Enemy {
            constructor() {
                this.radius = 35;
                this.x = Math.random() * (game3Canvas.width - this.radius * 2) + this.radius;
                this.y = -50;
                this.speed = Math.random() * 1.5 + 1; 
                
                this.denom = Math.floor(Math.random() * 7) + 2; 
                this.num = Math.floor(Math.random() * (this.denom * 2)) + 1;

                this.text = `${this.num}/${this.denom}`;
                this.isProper = (this.num < this.denom);
                this.isImproper = (this.num >= this.denom);
            }

            draw() {
                game3Ctx.save();
                game3Ctx.translate(this.x, this.y);
                if (this.isImproper) game3Ctx.fillStyle = "#ff6b6b";
                else game3Ctx.fillStyle = "#00d2d3";

                game3Ctx.beginPath();
                game3Ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                game3Ctx.fill();
                game3Ctx.strokeStyle = "#fff";
                game3Ctx.lineWidth = 2;
                game3Ctx.stroke();

                game3Ctx.fillStyle = "#fff";
                game3Ctx.font = "bold 20px Arial";
                game3Ctx.textAlign = "center";
                game3Ctx.textBaseline = "middle";
                game3Ctx.beginPath();
                game3Ctx.moveTo(-15, 0);
                game3Ctx.lineTo(15, 0);
                game3Ctx.strokeStyle = "white";
                game3Ctx.stroke();

                game3Ctx.font = "16px 'Jua'";
                game3Ctx.fillText(this.num, 0, -12);
                game3Ctx.fillText(this.denom, 0, 14);
                game3Ctx.restore();
            }
            update() { this.y += this.speed; }
        }

        // íŒŒí‹°í´
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.radius = Math.random() * 3 + 1;
                this.speedX = Math.random() * 4 - 2;
                this.speedY = Math.random() * 4 - 2;
                this.alpha = 1;
                this.color = color;
            }
            draw() {
                game3Ctx.save();
                game3Ctx.globalAlpha = this.alpha;
                game3Ctx.fillStyle = this.color;
                game3Ctx.beginPath();
                game3Ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                game3Ctx.fill();
                game3Ctx.restore();
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.alpha -= 0.02;
            }
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<15; i++) {
                game3State.particles.push(new Particle(x, y, color));
            }
        }

        function spawnEnemy() {
            if (game3State.frameCount % 60 === 0) game3State.enemies.push(new Enemy());
        }

        function updateGameLogic() {
            if (game3State.currentLevel === 1) {
                game3State.currentTarget = 'proper';
                setUiForTarget('proper');
                game3StageBanner.innerText = "STAGE 1";
            } else if (game3State.currentLevel === 2) {
                game3State.currentTarget = 'improper';
                setUiForTarget('improper');
                game3StageBanner.innerText = "STAGE 2";
                game3StageBanner.style.color = "rgba(255, 107, 107, 0.2)";
            } else if (game3State.currentLevel === 3) {
                game3StageBanner.innerText = "STAGE 3";
                game3StageBanner.style.color = "rgba(255, 215, 0, 0.2)";
                
                game3State.stage3SwitchTimer++;
                if (game3State.stage3SwitchTimer > 180) {
                    toggleTarget();
                    game3State.stage3SwitchTimer = 0;
                    game3TargetBadge.style.transform = "scale(1.2)";
                    setTimeout(() => game3TargetBadge.style.transform = "scale(1)", 200);
                }
            }
        }

        function setUiForTarget(type) {
            if (type === 'proper') {
                game3TargetBadge.innerText = "ì§„ë¶„ìˆ˜";
                game3TargetBadge.className = "target-badge badge-proper";
                game3TargetBadge.style.cssText = "background-color: #00d2d3; color: white; border-color: #01a3a4; padding: 10px 20px; border-radius: 5px; font-family: 'Black Han Sans', sans-serif; font-size: 1.8rem; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); border: 3px solid #01a3a4; transition: all 0.3s; text-align: center; min-width: 120px;";
            } else {
                game3TargetBadge.innerText = "ê°€ë¶„ìˆ˜";
                game3TargetBadge.className = "target-badge badge-improper";
                game3TargetBadge.style.cssText = "background-color: #ff6b6b; color: white; border-color: #ee5253; padding: 10px 20px; border-radius: 5px; font-family: 'Black Han Sans', sans-serif; font-size: 1.8rem; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); border: 3px solid #ee5253; transition: all 0.3s; text-align: center; min-width: 120px;";
            }
        }

        function toggleTarget() {
            if (game3State.currentTarget === 'proper') {
                game3State.currentTarget = 'improper';
                setUiForTarget('improper');
            } else {
                game3State.currentTarget = 'proper';
                setUiForTarget('proper');
            }
        }

        function checkCollisions() {
            for (let i = game3State.bullets.length - 1; i >= 0; i--) {
                for (let j = game3State.enemies.length - 1; j >= 0; j--) {
                    const b = game3State.bullets[i];
                    const e = game3State.enemies[j];
                    const dist = Math.hypot(b.x - e.x, b.y - e.y);
                    
                    if (dist < e.radius + b.radius) {
                        let isCorrectTarget = false;
                        if (game3State.currentTarget === 'proper' && e.isProper) isCorrectTarget = true;
                        if (game3State.currentTarget === 'improper' && e.isImproper) isCorrectTarget = true;

                        if (isCorrectTarget) {
                            createExplosion(e.x, e.y, "#ffd700");
                        } else {
                            game3State.lives--;
                            updateLives();
                            createExplosion(e.x, e.y, "#ff0000");
                            game3Canvas.style.transform = "translate(5px, 5px)";
                            setTimeout(() => game3Canvas.style.transform = "none", 100);
                        }
                        game3State.bullets.splice(i, 1);
                        game3State.enemies.splice(j, 1);
                        break;
                    }
                }
            }
            for (let i = game3State.enemies.length - 1; i >= 0; i--) {
                if (game3State.enemies[i].y > game3Canvas.height + 50) game3State.enemies.splice(i, 1);
            }
        }

        function updateLives() {
            let hearts = "";
            for(let i=0; i<game3State.lives; i++) hearts += "â¤ï¸";
            game3LivesEl.innerText = hearts;
            if (game3State.lives <= 0) handleGameOver(false);
        }

        function runTimer() {
            game3State.timeLeft = 60;
            game3TimerEl.innerText = game3State.timeLeft;
            game3TimerBox.classList.remove('timer-warning');

            if (game3State.timerInterval) clearInterval(game3State.timerInterval);
            
            game3State.timerInterval = setInterval(() => {
                if (!game3State.gameRunning) {
                    clearInterval(game3State.timerInterval);
                    return;
                }
                game3State.timeLeft--;
                game3TimerEl.innerText = game3State.timeLeft;

                if (game3State.timeLeft <= 10) game3TimerBox.classList.add('timer-warning');

                if (game3State.timeLeft <= 0) {
                    handleStageClear();
                }
            }, 1000);
        }

        function gameLoop() {
            if (!game3State.gameRunning || !game3Ctx || !game3Canvas) return;

            game3Ctx.fillStyle = "rgba(0, 0, 0, 0.3)"; 
            game3Ctx.fillRect(0, 0, game3Canvas.width, game3Canvas.height);
            if (Math.random() < 0.1) {
                game3Ctx.fillStyle = "white";
                game3Ctx.fillRect(Math.random()*game3Canvas.width, Math.random()*game3Canvas.height, 2, 2);
            }

            game3State.player.update();
            game3State.player.draw();

            game3State.bullets.forEach((b, index) => {
                b.update();
                b.draw();
                if (b.y < 0) game3State.bullets.splice(index, 1);
            });

            spawnEnemy();
            game3State.enemies.forEach((e) => {
                e.update();
                e.draw();
            });

            game3State.particles.forEach((p, index) => {
                p.update();
                p.draw();
                if (p.alpha <= 0) game3State.particles.splice(index, 1);
            });

            updateGameLogic(); 
            checkCollisions();
            
            game3State.frameCount++;
            requestAnimationFrame(gameLoop);
        }

        function startStage(level) {
            if (!game3Canvas || !game3Ctx) return;
            
            resizeGame3();
            game3State.gameRunning = true;
            game3State.currentLevel = level;
            
            game3State.lives = 3; 
            game3State.timeLeft = 60;
            game3State.enemies = [];
            game3State.bullets = [];
            game3State.particles = [];
            
            updateLives();
            game3StageNumEl.innerText = game3State.currentLevel;
            game3Overlay.style.display = 'none';
            game3State.player = createPlayer();
            game3State.player.x = game3Canvas.width / 2;

            if (level === 3) {
                game3State.stage3SwitchTimer = 0;
                game3State.currentTarget = 'proper'; 
            }

            runTimer();
            gameLoop();
        }
        window.startStage = startStage;

        function handleStageClear() {
            game3State.gameRunning = false;
            clearInterval(game3State.timerInterval);
            game3Overlay.style.display = 'flex';

            if (game3State.currentLevel === 1) {
                game3OverlayContent.innerHTML = `
                    <h1 style="color:#00d4ff; font-family: 'Black Han Sans', sans-serif; font-size: 3rem; margin-bottom: 20px;">ğŸ‰ 1ë‹¨ê³„ ì„±ê³µ! ğŸ‰</h1>
                    <p style="text-align: center; font-size: 1.3rem; margin-bottom: 10px; color: #ccc; line-height: 1.6;">ì§„ë¶„ìˆ˜ ê³µê²© ì„±ê³µ!<br>ì´ì œ <strong>ê°€ë¶„ìˆ˜</strong>ê°€ ëª°ë ¤ì˜µë‹ˆë‹¤.</p>
                    <button class="start-btn" onclick="startStage(2)" style="padding: 15px 40px; font-size: 1.8rem; font-family: 'Black Han Sans', sans-serif; background-color: #ff4757; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 5px 0 #c0392b; transition: transform 0.1s; pointer-events: auto; z-index: 101; margin-top: 20px;">2ë‹¨ê³„ ë„ì „!</button>
                `;
            } else if (game3State.currentLevel === 2) {
                game3OverlayContent.innerHTML = `
                    <h1 style="color:#ff6b6b; font-family: 'Black Han Sans', sans-serif; font-size: 3rem; margin-bottom: 20px;">ğŸ‰ 2ë‹¨ê³„ ì„±ê³µ! ğŸ‰</h1>
                    <p style="text-align: center; font-size: 1.3rem; margin-bottom: 10px; color: #ccc; line-height: 1.6;">ê°€ë¶„ìˆ˜ ê³µê²© ì„±ê³µ!<br>ì´ì œ <strong>ì§„ë¶„ìˆ˜ì™€ ê°€ë¶„ìˆ˜</strong>ê°€<br>ë²ˆê°ˆì•„ ë‚˜ì˜µë‹ˆë‹¤!</p>
                    <button class="start-btn" onclick="startStage(3)" style="padding: 15px 40px; font-size: 1.8rem; font-family: 'Black Han Sans', sans-serif; background-color: #ff4757; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 5px 0 #c0392b; transition: transform 0.1s; pointer-events: auto; z-index: 101; margin-top: 20px;">ë§ˆì§€ë§‰ ë„ì „!</button>
                `;
            } else {
                game3OverlayContent.innerHTML = `
                    <h1 style="color:#ffd700; font-family: 'Black Han Sans', sans-serif; font-size: 3rem; margin-bottom: 20px;">ğŸ† ì§€êµ¬ ë°©ìœ„ ì„±ê³µ! ğŸ†</h1>
                    <p style="text-align: center; font-size: 1.3rem; margin-bottom: 10px; color: #ccc; line-height: 1.6;">ëª¨ë“  ë¶„ìˆ˜ ê³µê²©ì„ ë§‰ì•„ëƒˆìŠµë‹ˆë‹¤!<br>ë‹¹ì‹ ì€ ìµœê³ ì˜ ìš°ì£¼ ì¡°ì¢…ì‚¬!</p>
                    <button class="start-btn" onclick="showGame3Intro()" style="padding: 15px 40px; font-size: 1.8rem; font-family: 'Black Han Sans', sans-serif; background-color: #ff4757; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 5px 0 #c0392b; transition: transform 0.1s; pointer-events: auto; z-index: 101; margin-top: 20px;">ì²˜ìŒìœ¼ë¡œ</button>
                `;
            }
        }

        function handleGameOver() {
            game3State.gameRunning = false;
            clearInterval(game3State.timerInterval);
            game3Overlay.style.display = 'flex';
            game3OverlayContent.innerHTML = `
                <h1 style="color:#ff4757; font-family: 'Black Han Sans', sans-serif; font-size: 3rem; margin-bottom: 20px;">ğŸ’€ ê²Œì„ ì˜¤ë²„ ğŸ’€</h1>
                <p style="text-align: center; font-size: 1.3rem; margin-bottom: 10px; color: #ccc; line-height: 1.6;">ì•„ì‰½ê²Œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ë‹¤ì‹œ ë„ì „í•´ ë³¼ê¹Œìš”?</p>
                <button class="start-btn" onclick="startStage(${game3State.currentLevel})" style="padding: 15px 40px; font-size: 1.8rem; font-family: 'Black Han Sans', sans-serif; background-color: #ff4757; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 5px 0 #c0392b; transition: transform 0.1s; pointer-events: auto; z-index: 101; margin-top: 20px;">ì¬ë„ì „</button>
            `;
        }

        function showGame3Intro() {
            game3Overlay.style.display = 'flex';
            game3OverlayContent.innerHTML = `
                <h1 style="color:#ffd700; font-family: 'Black Han Sans', sans-serif; font-size: 3rem; margin-bottom: 20px; line-height: 1.2;">ì§€êµ¬ë¥¼ ì§€ì¼œë¼!<br>ë¶„ìˆ˜ ëŒ€ì „ìŸ</h1>
                <p style="text-align: center; font-size: 1.3rem; margin-bottom: 10px; color: #ccc; line-height: 1.6;">
                    <strong>ì´ 3ë‹¨ê³„ ë¯¸ì…˜</strong>ì„ ì™„ë£Œí•˜ì„¸ìš”.<br>
                    <span style="color:#00d4ff">1ë‹¨ê³„: ì§„ë¶„ìˆ˜</span> / 
                    <span style="color:#ff6b6b">2ë‹¨ê³„: ê°€ë¶„ìˆ˜</span> / 
                    <span style="color:#ffd700">3ë‹¨ê³„: í˜¼í•©</span>
                </p>
                <button class="start-btn" onclick="startStage(1)" style="padding: 15px 40px; font-size: 1.8rem; font-family: 'Black Han Sans', sans-serif; background-color: #ff4757; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 5px 0 #c0392b; transition: transform 0.1s; pointer-events: auto; z-index: 101; margin-top: 20px;">1ë‹¨ê³„ ì¶œê²©!</button>
            `;
        }
        window.showGame3Intro = showGame3Intro;

        // ========== Section 6: ì‹¤ì „! ë¬¸ì¥ì œ ë¬¸ì œ í’€ê¸° ==========
        let section6State = {
            currentProblem: null,  // í˜„ì¬ ë¬¸ì œ {story_before, numerator, denominator, story_after, answer}
            chatHistory: []        // AI ì±—ë´‡ ëŒ€í™” ê¸°ë¡
        };
        
        // ì°¸ê³ ìš© ë¬¸ì œ ë°ì´í„° (í…œí”Œë¦¿ ì¹˜í™˜ìš©)
        const referenceProblems = [
            { story_before: "í™˜í¬ëŠ” ì‚¬ê³¼ 24ê°œ ì¤‘ì—ì„œ", numerator: 1, denominator: 4, story_after: "ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤. ëª‡ ê°œì˜ ì‚¬ê³¼ë¥¼ ë¨¹ì—ˆìŠµë‹ˆê¹Œ?", answer: 6 },
            { story_before: "ë„ì„œê´€ì— ì±…ì´ 30ê¶Œ ìˆìŠµë‹ˆë‹¤. ê·¸ì¤‘", numerator: 1, denominator: 5, story_after: "ì´ ë™í™”ì±…ì…ë‹ˆë‹¤. ë™í™”ì±…ì€ ëª‡ ê¶Œì…ë‹ˆê¹Œ?", answer: 6 },
            { story_before: "ì´ë¡œëŠ” ì¼€ì´í¬ë¥¼ 12ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆ„ì—ˆìŠµë‹ˆë‹¤. ê·¸ì¤‘", numerator: 1, denominator: 3, story_after: "ì„ ë¨¹ì—ˆìŠµë‹ˆë‹¤. ëª‡ ì¡°ê°ì„ ë¨¹ì—ˆìŠµë‹ˆê¹Œ?", answer: 4 },
            { story_before: "í•™ê¸‰ì— 20ëª…ì˜ ì¹œêµ¬ê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ì¤‘", numerator: 1, denominator: 5, story_after: "ê°€ ì•ˆê²½ì„ ì”ë‹ˆë‹¤. ì•ˆê²½ì„ ì“°ëŠ” ì¹œêµ¬ëŠ” ëª‡ ëª…ì…ë‹ˆê¹Œ?", answer: 4 },
            { story_before: "ìˆ˜í¬ ì§‘ì˜ í•œ ìƒìì— ì—°í•„ì´ 18ìë£¨ ìˆìŠµë‹ˆë‹¤. ê·¸ì¤‘", numerator: 1, denominator: 6, story_after: "ì„ í˜•ë¯¼ì´ì—ê²Œ ë‚˜ëˆ„ì–´ ì£¼ì—ˆìŠµë‹ˆë‹¤. ë‚˜ëˆ„ì–´ ì¤€ ì—°í•„ì€ ëª‡ ìë£¨ì…ë‹ˆê¹Œ?", answer: 3 },
            { story_before: "ë‚˜ìœ¨ì´ëŠ” ì´ˆì½œë¦¿ 24ê°œ ì¤‘ì—ì„œ", numerator: 1, denominator: 8, story_after: "ì„ ë¯¼ì„ ì´ì™€ ë‚˜ëˆ„ì–´ ë¨¹ì—ˆìŠµë‹ˆë‹¤. ëª‡ ê°œë¥¼ ë¨¹ì—ˆìŠµë‹ˆê¹Œ?", answer: 3 },
            { story_before: "ë„ì„œê´€ì— ìˆëŠ” ì±… 45ê¶Œ ì¤‘", numerator: 1, denominator: 5, story_after: "ê°€ ê³¼í•™ì±…ì…ë‹ˆë‹¤. ê³¼í•™ì±…ì€ ëª‡ ê¶Œì…ë‹ˆê¹Œ?", answer: 9 },
            { story_before: "ìš´ë™ì¥ì— ìˆëŠ” í•™ìƒ 27ëª… ì¤‘", numerator: 1, denominator: 3, story_after: "ì´ ì¤„ë„˜ê¸°ë¥¼ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¤„ë„˜ê¸°ë¥¼ í•˜ëŠ” í•™ìƒì€ ëª‡ ëª…ì…ë‹ˆê¹Œ?", answer: 9 },
            { story_before: "ì˜ˆë¦°ì´ëŠ” ì¿ í‚¤ 16ê°œ ì¤‘", numerator: 1, denominator: 4, story_after: "ì„ íƒœë¦°ì´ì—ê²Œ ì£¼ì—ˆìŠµë‹ˆë‹¤. ì¹œêµ¬ì—ê²Œ ì¤€ ì¿ í‚¤ëŠ” ëª‡ ê°œì…ë‹ˆê¹Œ?", answer: 4 },
            { story_before: "ë„ìœ¤ì´ì˜ ë³´ë¬¼ìƒìì— ê³¼ì 20ê°œê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ì¤‘", numerator: 1, denominator: 4, story_after: "ì„ ì¹œêµ¬ë“¤ì—ê²Œ ë‚˜ëˆ„ì–´ ì£¼ì—ˆìŠµë‹ˆë‹¤. ë‚˜ëˆ„ì–´ ì¤€ ê³¼ìëŠ” ëª‡ ê°œì…ë‹ˆê¹Œ?", answer: 5 }
        ];
        
        // ë¬¸ì œ ìƒì„± (OpenAI API)
        async function generateWordProblem() {
            const generateBtn = document.getElementById('generate-problem-btn');
            const problemArea = document.getElementById('word-problem-area');
            const tutorArea = document.getElementById('ai-tutor-area');
            const feedback = document.getElementById('word-problem-feedback');
            const answerInput = document.getElementById('word-problem-answer');
            
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'ìƒì„± ì¤‘...';
            }
            
            const currentAPIKey = API_KEY_FINAL || window.VITE_OPENAI_API_KEY || import.meta.env.VITE_OPENAI_API_KEY;
            
            if (!currentAPIKey) {
                alert('API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ğŸ² ìƒˆë¡œìš´ ë¬¸ì œ ë§Œë“¤ê¸°';
                }
                return;
            }
            
            try {
                // ì°¸ê³  ë¬¸ì œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const referenceProblemsJSON = JSON.stringify(referenceProblems, null, 2);
                
                const systemPrompt = `ë‹¹ì‹ ì€ ìˆ˜í•™ ë¬¸ì œ ìƒì„±ê¸°ì…ë‹ˆë‹¤.

**ì‘ì—… ì§€ì‹œ:**
1. ì•„ë˜ ì œê³µëœ [ì°¸ê³  ë¬¸ì œ ë°ì´í„°] 10ê°œ ì¤‘ í•˜ë‚˜ë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ íƒí•˜ì„¸ìš”.
2. ë¬¸ì¥ì˜ êµ¬ì¡°ì™€ ì¡°ì‚¬(~ì€/ëŠ”/ì´/ê°€/~ì„/ë¥¼)ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³ , **ë“±ì¥ì¸ë¬¼ì˜ ì´ë¦„**ê³¼ **ì „ì²´ ê°œìˆ˜(Total)**, **ë¶„ìˆ˜(Fraction)**ë§Œ ë³€ê²½í•˜ì„¸ìš”.
3. **[í•„ìˆ˜ ì œì•½]** ì •ë‹µ(Answer)ì€ ë°˜ë“œì‹œ ìì—°ìˆ˜(Natural Number)ê°€ ë˜ë„ë¡ ê³„ì‚°ì´ ë”± ë–¨ì–´ì§€ëŠ” ìˆ«ìë¥¼ ì„¤ì •í•˜ì„¸ìš”.
4. **[ì¶œë ¥ í¬ë§·]** JSONì˜ \`story_before\`ì™€ \`story_after\`ì—ëŠ” '1/6' ê°™ì€ ë¶„ìˆ˜ í…ìŠ¤íŠ¸ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. (UIì—ì„œ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤„ ê²ƒì…ë‹ˆë‹¤.)

**ì°¸ê³  ë¬¸ì œ ë°ì´í„°:**
${referenceProblemsJSON}

**JSON Response ì˜ˆì‹œ (Strict):**
{
  "story_before": "ì§€ë¯¼ì´ëŠ” ê³¼ì 36ê°œ ì¤‘ì—ì„œ",
  "numerator": 1,
  "denominator": 6,
  "story_after": "ì„ ì¹œêµ¬ë“¤ê³¼ ë‚˜ëˆ„ì—ˆìŠµë‹ˆë‹¤. ëª‡ ê°œë¥¼ ë‚˜ëˆ„ì–´ ì£¼ì—ˆë‚˜ìš”?",
  "answer": 6
}

**ì£¼ì˜ì‚¬í•­:**
- story_beforeì™€ story_afterì— "1/6" ê°™ì€ ë¶„ìˆ˜ í…ìŠ¤íŠ¸ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
- ë¬¸ì¥ êµ¬ì¡°ëŠ” ì°¸ê³  ë¬¸ì œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ì„¸ìš”.
- ì´ë¦„ê³¼ ìˆ«ìë§Œ ë³€ê²½í•˜ì„¸ìš”.

JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;
                
                // ëª¨ë¸ ì„ íƒ (gpt-4o ìš°ì„ , ì—†ìœ¼ë©´ gpt-4-turbo)
                const model = 'gpt-4o'; // gpt-4o ì‚¬ìš©
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAPIKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: 'ìœ„ ì¡°ê±´ì— ë§ëŠ” ìƒˆë¡œìš´ ë¬¸ì œë¥¼ 1ê°œ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ì°¸ê³  ë¬¸ì œ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì„œ ì´ë¦„ê³¼ ìˆ«ìë§Œ ë°”ê¾¸ì„¸ìš”. JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.' }
                        ],
                        max_tokens: 300,
                        temperature: 0.3, // ë‚®ì€ temperatureë¡œ ì¼ê´€ì„± í™•ë³´
                        response_format: { type: "json_object" }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // JSON íŒŒì‹±
                let problem;
                try {
                    problem = JSON.parse(content);
                } catch (e) {
                    // JSONì´ ì•„ë‹Œ ê²½ìš°, JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ ì‹œë„
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        problem = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }
                }
                
                // ë¬¸ì œ ì €ì¥
                section6State.currentProblem = problem;
                section6State.chatHistory = []; // ìƒˆ ë¬¸ì œë§ˆë‹¤ ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™”
                
                // ë¬¸ì œ í‘œì‹œ
                displayWordProblem(problem);
                
                // ì˜ì—­ í‘œì‹œ
                if (problemArea) problemArea.classList.remove('hidden');
                if (tutorArea) tutorArea.classList.remove('hidden');
                if (feedback) feedback.innerHTML = '';
                if (answerInput) {
                    answerInput.value = '';
                    answerInput.focus();
                }
                
            } catch (error) {
                console.error('ë¬¸ì œ ìƒì„± ì˜¤ë¥˜:', error);
                alert(`ë¬¸ì œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ğŸ² ìƒˆë¡œìš´ ë¬¸ì œ ë§Œë“¤ê¸°';
                }
            }
        }
        
        // ë¬¸ì œ í‘œì‹œ (ì„¸ë¡œ ë¶„ìˆ˜ í‘œê¸°)
        function displayWordProblem(problem) {
            const display = document.getElementById('word-problem-display');
            if (!display) return;
            
            // ë¶„ìˆ˜ ì»´í¬ë„ŒíŠ¸ ìƒì„±
            const fractionHTML = `
                <div class="flex flex-col items-center justify-center mx-1">
                    <span class="text-2xl md:text-3xl font-semibold">${problem.numerator}</span>
                    <div class="border-b-2 border-black w-full my-1"></div>
                    <span class="text-2xl md:text-3xl font-semibold">${problem.denominator}</span>
                </div>
            `;
            
            // ë¬¸ì œ í…ìŠ¤íŠ¸ì™€ ë¶„ìˆ˜ë¥¼ ì¡°í•©
            display.innerHTML = `
                <span>${problem.story_before}</span>
                ${fractionHTML}
                <span>${problem.story_after}</span>
            `;
        }
        
        // ì •ë‹µ í™•ì¸
        function checkWordProblemAnswer() {
            if (!section6State.currentProblem) {
                alert('ë¨¼ì € ë¬¸ì œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const answerInput = document.getElementById('word-problem-answer');
            const feedback = document.getElementById('word-problem-feedback');
            
            if (!answerInput || !feedback) return;
            
            const userAnswer = parseInt(answerInput.value);
            const correctAnswer = section6State.currentProblem.answer;
            
            if (isNaN(userAnswer)) {
                feedback.innerHTML = '<span class="text-red-600">ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!</span>';
                return;
            }
            
            if (userAnswer === correctAnswer) {
                feedback.innerHTML = `
                    <div class="text-4xl font-bold text-green-600 animate-bounce">
                        ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!
                    </div>
                `;
            } else {
                feedback.innerHTML = `
                    <div class="text-2xl font-bold text-red-600">
                        ğŸ¤” ë‹¤ì‹œ ìƒê°í•´ë³¼ê¹Œìš”?
                    </div>
                    <div class="text-lg text-gray-600 mt-2">
                        íŒíŠ¸: AI ì„ ìƒë‹˜ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!
                    </div>
                `;
            }
        }
        
        // AI ì±—ë´‡ ë©”ì‹œì§€ ì „ì†¡
        async function sendAIChatMessage() {
            if (!section6State.currentProblem) {
                alert('ë¨¼ì € ë¬¸ì œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const input = document.getElementById('ai-chat-input');
            const messagesArea = document.getElementById('ai-chat-messages');
            
            if (!input || !messagesArea) return;
            
            const userMessage = input.value.trim();
            if (!userMessage) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addChatMessage('user', userMessage);
            input.value = '';
            
            // AI ì‘ë‹µ ëŒ€ê¸° í‘œì‹œ
            const loadingId = addChatMessage('assistant', 'ğŸ’­ ìƒê°í•˜ê³  ìˆì–´ìš”...', true);
            
            const currentAPIKey = API_KEY_FINAL || window.VITE_OPENAI_API_KEY || import.meta.env.VITE_OPENAI_API_KEY;
            
            if (!currentAPIKey) {
                updateChatMessage(loadingId, 'assistant', 'âŒ API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const systemPrompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™êµ 3í•™ë…„ ì•„ì´ë“¤ì„ ìœ„í•œ ë‹¤ì •í•œ ìˆ˜í•™ ì„ ìƒë‹˜ì…ë‹ˆë‹¤.

**ì¤‘ìš” ê·œì¹™:**
1. í•™ìƒì´ ì§ˆë¬¸í•˜ë©´ ì •ë‹µì„ ë°”ë¡œ ì•Œë ¤ì£¼ì§€ ë§ê³  íŒíŠ¸ë¥¼ ì£¼ì„¸ìš”.
2. **[ì¤‘ìš”]** ì„¤ëª…ì„ í•  ë•ŒëŠ” í”¼ìë‚˜ ì¼€ì´í¬ ê°™ì€ ê³ ì •ëœ ë¹„ìœ ë¥¼ ë“¤ì§€ ë§ê³ , **í˜„ì¬ ë¬¸ì œì— ë‚˜ì˜¤ëŠ” ì†Œì¬(ì˜ˆ: ì—°í•„ì´ë©´ ì—°í•„, ê³¼ìë©´ ê³¼ì, ì‚¬ëŒì´ë©´ ì‚¬ëŒ)**ë¥¼ ê·¸ëŒ€ë¡œ í™œìš©í•´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”.
3. 'ì „ì²´ ê°œìˆ˜ë¥¼ ë¶„ëª¨ë§Œí¼ ë¬¶ìŒìœ¼ë¡œ ë‚˜ëˆ„ì–´ë³´ì'ëŠ” ì‹ìœ¼ë¡œ êµ¬ì²´ì ì¸ í–‰ë™ì„ ê°€ì´ë“œí•´ì£¼ì„¸ìš”.
4. ì¹œì ˆí•˜ê³  ê²©ë ¤í•˜ëŠ” ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
5. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì„¸ìš”.

**í˜„ì¬ í•™ìƒì´ í’€ê³  ìˆëŠ” ë¬¸ì œ:**
${JSON.stringify(section6State.currentProblem, null, 2)}

ë¬¸ì œì˜ ì •ë‹µì€ ${section6State.currentProblem.answer}ì´ì§€ë§Œ, ì ˆëŒ€ ì´ ìˆ«ìë¥¼ ì§ì ‘ ë§í•˜ì§€ ë§ˆì„¸ìš”. ëŒ€ì‹  í’€ì´ ë°©ë²•ê³¼ íŒíŠ¸ë¥¼ ì£¼ì„¸ìš”. ë¬¸ì œì— ë‚˜ì˜¤ëŠ” ì†Œì¬ë¥¼ í™œìš©í•´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”.`;
                
                // ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€
                section6State.chatHistory.push({ role: 'user', content: userMessage });
                
                // ëª¨ë¸ ì„ íƒ (gpt-4o ìš°ì„ , ì—†ìœ¼ë©´ gpt-4-turbo)
                const model = 'gpt-4o'; // gpt-4o ì‚¬ìš©
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAPIKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...section6State.chatHistory.map(msg => ({ role: msg.role, content: msg.content }))
                        ],
                        max_tokens: 300,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                const aiMessage = data.choices[0].message.content;
                
                // ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€
                section6State.chatHistory.push({ role: 'assistant', content: aiMessage });
                
                // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                updateChatMessage(loadingId, 'assistant', aiMessage);
                
            } catch (error) {
                console.error('AI ì±—ë´‡ ì˜¤ë¥˜:', error);
                updateChatMessage(loadingId, 'assistant', `ğŸ˜¢ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ${error.message}`);
            }
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(role, content, isLoading = false) {
            const messagesArea = document.getElementById('ai-chat-messages');
            if (!messagesArea) return null;
            
            // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
            if (messagesArea.children.length === 1 && messagesArea.children[0].textContent.includes('AI ì„ ìƒë‹˜ì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”')) {
                messagesArea.innerHTML = '';
            }
            
            const messageId = `chat-msg-${Date.now()}-${Math.random()}`;
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `mb-4 ${role === 'user' ? 'text-right' : 'text-left'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `inline-block max-w-[80%] px-4 py-2 rounded-xl ${
                role === 'user' 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 text-gray-800'
            }`;
            bubbleDiv.textContent = content;
            
            messageDiv.appendChild(bubbleDiv);
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            return messageId;
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        function updateChatMessage(messageId, role, content) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const bubbleDiv = messageDiv.querySelector('div');
            if (bubbleDiv) {
                bubbleDiv.textContent = content;
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
        window.generateWordProblem = generateWordProblem;
        window.checkWordProblemAnswer = checkWordProblemAnswer;
        window.sendAIChatMessage = sendAIChatMessage;

        const game3Keys = {};
        document.addEventListener('keydown', e => {
            if (!game3State.gameRunning || !game3State.player) return;
            game3Keys[e.code] = true;
            if (e.code === 'ArrowLeft') game3State.player.dx = -game3State.player.speed;
            if (e.code === 'ArrowRight') game3State.player.dx = game3State.player.speed;
            if (e.code === 'Space') game3State.bullets.push(new Bullet(game3State.player.x, game3State.player.y - 20));
        });
        document.addEventListener('keyup', e => {
            if (!game3State.gameRunning || !game3State.player) return;
            game3Keys[e.code] = false;
            if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') game3State.player.dx = 0;
            if (game3Keys['ArrowLeft']) game3State.player.dx = -game3State.player.speed;
            if (game3Keys['ArrowRight']) game3State.player.dx = game3State.player.speed;
        });
        
        game3Canvas?.addEventListener('touchstart', e => { e.preventDefault(); handleTouch(e.touches[0].clientX); });
        game3Canvas?.addEventListener('touchmove', e => { e.preventDefault(); handleTouch(e.touches[0].clientX); });
        game3Canvas?.addEventListener('touchend', () => { if (game3State.player) game3State.player.dx = 0; });
        function handleTouch(touchX) {
            if (!game3State.gameRunning || !game3State.player) return;
            if (touchX < window.innerWidth / 2 - 50) game3State.player.dx = -game3State.player.speed;
            else if (touchX > window.innerWidth / 2 + 50) game3State.player.dx = game3State.player.speed; 
            else game3State.bullets.push(new Bullet(game3State.player.x, game3State.player.y - 20));
        }

        // ========== ì´ˆê¸°í™” ==========
        document.addEventListener('DOMContentLoaded', async function() {
            showSection('home');
            updateDisplay();
            drawFraction();
            
            // API Key ê²€ì¦
            await checkAPIKey();
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('aiModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAIModal();
            }
        });
    </script>
</body>
</html>
